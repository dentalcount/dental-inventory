<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Dental Inventory</title>

<!-- Favicon (inline). Replace with: <link rel="icon" href="favicon.ico"> if you add a file -->
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3EðŸ¦·%3C/text%3E%3C/svg%3E">

<!-- Supabase SDK -->
<script src="https://unpkg.com/@supabase/supabase-js@2.44.4/dist/umd/supabase.js"></script>

<style>
  :root{--muted:#94a3b8;--text:#e5e7eb;--bg:#0b1220;--panel:#0c1426;--border:rgba(255,255,255,.10);--accent:#22d3ee}
  html,body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .wrap{max-width:1100px;margin:0 auto;padding:20px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px;margin:14px 0}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
  input,button,select{width:100%;padding:.7rem .8rem;border-radius:12px;border:1px solid var(--border);background:#0d1526;color:#e5e7eb;outline:none}
  input:focus,select:focus{border-color:var(--accent)}
  input[type="date"]{color-scheme:dark}
  .btn{cursor:pointer;border:none}
  .btn[disabled]{opacity:.6;cursor:not-allowed}
  .btn.primary{background:linear-gradient(90deg,#00c2ff,#14f1d9);color:#022;font-weight:700}
  .btn.alt{background:#1f2937}
  .hidden{display:none!important}
  .tabs{display:flex;gap:8px;margin:8px 0 0}
  .tab{padding:.5rem .8rem;border:1px solid var(--border);border-radius:999px;background:#101830;cursor:pointer}
  .tab.active{background:linear-gradient(90deg,#00c2ff,#14f1d9);color:#022;font-weight:700}
  table{width:100%;border-collapse:separate;border-spacing:0 8px}
  th,td{padding:.6rem .55rem;text-align:left}
  thead th{font-size:.85rem;color:var(--muted)}
  tbody tr{background:#0d1629;border:1px solid rgba(255,255,255,.08)}
  tbody tr td:first-child{border-top-left-radius:10px;border-bottom-left-radius:10px}
  tbody tr td:last-child{border-top-right-radius:10px;border-bottom-right-radius:10px}
  .badge{padding:.2rem .5rem;border-radius:999px;border:1px solid var(--border);font-size:.75rem}
  .mono{font-family: ui-monospace, Menlo, Monaco, Consolas, monospace;}
  /* Debug dock */
  #debug{position:fixed;left:0;right:0;bottom:0;max-height:46vh;overflow:auto;background:#0a0f1d;border-top:1px solid var(--border);font-size:12px;z-index:40}
  #dbgHead{display:flex;gap:8px;align-items:center;padding:8px;border-bottom:1px solid var(--border)}
  #dbgBody{padding:8px}
  pre{white-space:pre-wrap;font-family:ui-monospace,Menlo,Consolas,monospace;margin:0}
  /* Scanner modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:50}
  .sheet{background:#0b1220;border:1px solid var(--border);border-radius:16px;padding:16px;max-width:680px;width:92%}
  video{width:100%;max-height:300px;background:#000;border-radius:12px;border:1px solid var(--border)}
  .hint{color:var(--muted);font-size:.85rem}
  .file{display:inline-block;padding:.5rem .7rem;border:1px dashed var(--border);border-radius:8px;background:#101830;cursor:pointer}
  .file input{display:none}
</style>
</head>
<body>
<div class="wrap">
  <h1 style="display:flex;justify-content:space-between;align-items:center">
    <span>Dental Inventory <span id="roleBadge" class="badge hidden"></span></span>
    <span style="display:flex;gap:8px;align-items:center">
      <span id="userEmail" class="badge hidden"></span>
      <button id="btnShowDebug" class="btn alt">Show Debug</button>
      <button id="btnInAppReset" class="btn alt">Reset Session</button>
      <button id="btnSignOut" class="btn alt">Sign out</button>
    </span>
  </h1>

  <!-- Auth -->
  <div id="authCard" class="card">
    <div class="row">
      <div><input id="email" type="email" placeholder="you@clinic.com"/></div>
      <div style="align-self:end"><button id="btnMagic" class="btn primary">Send Magic Link</button></div>
    </div>
    <div class="row" style="margin-top:8px">
      <div><button id="btnGoogle" class="btn alt">Continue with Google</button></div>
      <div><button id="btnReset" class="btn alt">Reset Session</button></div>
    </div>
    <div class="hint" style="margin-top:8px">If Google shows the account chooser then returns here, thatâ€™s expectedâ€”PKCE finishes the sign-in on this page.</div>
  </div>

  <!-- App -->
  <div id="app" class="hidden">

    <!-- Tabs -->
    <div class="tabs">
      <button id="tabCatalogue" class="tab active">Catalogue</button>
      <button id="tabReorder" class="tab">Re-Ordering</button>
    </div>

    <!-- PAGE: CATALOGUE -->
    <section id="pageCatalogue">
      <div class="card">
        <div class="row3">
          <div>
            <div style="display:flex;gap:8px">
              <input id="inBarcode" class="mono" placeholder="Scan or type barcodeâ€¦"/>
              <button id="btnScan" class="btn alt" style="width:auto">ðŸ“· Scan</button>
            </div>
          </div>
          <div><input id="inName" placeholder="Item Name (required for new)"/></div>
          <div><input id="inUnit" placeholder="Unit (e.g., box / pack / ea)"/></div>
        </div>
        <div class="row3" style="margin-top:8px">
          <div><input id="inPack" placeholder="Pack size (e.g., x10 / 50pcs / 3g)"/></div>
          <div><input id="inExpiry" type="date" placeholder="Expiry Date"/></div>
          <div style="display:flex;gap:8px;align-items:center;justify-content:flex-end">
            <label class="file"><input id="inPhoto" type="file" accept="image/*" capture="environment"/>Upload Photo</label>
            <span id="photoName" class="hint"></span>
            <button id="btnAdd" class="btn primary">Save / Upsert</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          <input id="inSearch" placeholder="Search name or barcodeâ€¦" class="mono" style="flex:1 1 280px"/>
          <button id="btnRefresh" class="btn">Refresh</button>
          <button id="btnExport" class="btn">Export CSV</button>
          <!-- Admin-only controls -->
          <label id="lblImport" class="file hidden"><input id="inImport" type="file" accept=".csv"/>Import CSV (admin)</label>
          <span id="orgHint" class="badge"></span>
        </div>
        <div class="hint" style="margin-top:6px">Tip: click a field to edit inline. Press Enter to save.</div>
        <div style="overflow:auto;margin-top:8px">
          <table>
            <thead><tr>
              <th>Photo</th><th>Barcode</th><th>Name</th><th>Unit</th><th>Pack</th><th>Expiry</th><th>Days</th><th>Owner</th><th>Actions</th>
            </tr></thead>
            <tbody id="tblBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- PAGE: RE-ORDERING -->
    <section id="pageReorder" class="hidden">
      <div class="card">
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          <label>Expiring within
            <input id="reDays" type="number" min="1" value="60" style="width:90px;margin-left:6px"/> days
          </label>
          <label style="display:flex;gap:6px;align-items:center;margin-left:12px">
            <input id="reShowExpired" type="checkbox"/> include already expired
          </label>
          <button id="btnFindExpiring" class="btn primary" style="width:auto">Find expiring</button>
          <input id="reSearch" placeholder="Filter name/barcodeâ€¦" class="mono" style="flex:1 1 240px"/>
        </div>
        <div class="hint" style="margin-top:6px">Shows items with an Expiry Date set that are due within the chosen window.</div>
        <div style="overflow:auto;margin-top:8px">
          <table>
            <thead><tr>
              <th>Barcode</th><th>Name</th><th>Unit</th><th>Pack</th><th>Expiry</th><th>Days</th><th>Owner</th>
            </tr></thead>
            <tbody id="tblExpiring"></tbody>
          </table>
        </div>
      </div>
    </section>

  </div>
</div>

<!-- Scanner Modal -->
<div id="scanModal" class="modal hidden" aria-hidden="true">
  <div class="sheet">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <strong>Barcode Scanner</strong>
      <button id="btnScanClose" class="btn alt" style="width:auto">Close</button>
    </div>
    <video id="scanVideo" playsinline></video>
    <div class="hint" style="margin-top:6px">If scanning doesnâ€™t start, type the barcode manually.</div>
  </div>
</div>

<!-- Debug Panel (opens only with ?debug=1) -->
<div id="debug" class="hidden">
  <div id="dbgHead">
    <button id="btnDbgRead" class="btn alt" style="width:auto">Perms: Read</button>
    <button id="btnDbgWrite" class="btn alt" style="width:auto">Perms: Write</button>
    <button id="btnDbgRaw" class="btn alt" style="width:auto">Raw REST</button>
    <span id="dbgStatus" style="margin-left:auto;color:#94a3b8"></span>
  </div>
  <div id="dbgBody">
    <div class="hint">URL: <span id="dbgUrl"></span></div>
    <pre id="log"></pre>
  </div>
</div>

<script>
(function(){
  /*** CONFIG ***/
  const REDIRECT_URL  = 'https://dentalcount.github.io/dental-inventory/';
  const SUPABASE_URL  = 'https://sgjoadsefpcixvmthtfy.supabase.co';
  const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNnam9hZHNlZnBjaXh2bXRodGZ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwMDIyMjYsImV4cCI6MjA3NDU3ODIyNn0.UcmAuHzEtKZIBs0pGkcLyRIYcLzCA4tNfuuDkUVLpU8';
  const STORAGE_BUCKET = 'product_photos';
  /***************/

  // Helpers & Debug (bullet-proof)
  const $ = id => document.getElementById(id);
  const qs = new URLSearchParams(location.search);
  const DEBUG = qs.get('debug') === '1'; // only with ?debug=1
  const logEl = $('log'), dbgUrl = $('dbgUrl');

  const ts = ()=> new Date().toISOString().split('T')[1].replace('Z','');
  function dbg(...a){
    try {
      const parts = a.map(x=>{
        try{
          if (typeof x==='string') return x;
          if (x instanceof Event) return `[Event:${x.type}]`;
          return JSON.stringify(x, (_k,v)=> (v===window||v===document)?'[window/document]':v);
        } catch {
          try { return String(x); } catch { return '[unserializable]'; }
        }
      });
      console.log('[DBG]', ...a);
      if (DEBUG && logEl) logEl.textContent += `[${ts()}] ` + parts.join(' ') + '\n';
    } catch (e) {
      console.log('[DBG-FALLBACK]', ...a, '(dbg err:', e?.message, ')');
    }
  }
  const on = (el, ev, fn)=>{ if(!el){ if(DEBUG) dbg('wire skipped (missing element)'); return; } el.addEventListener(ev, fn, { passive:true }); };
  const setBusy = (btn,on,label='Workingâ€¦',idle)=>{ if(!btn) return; if(on){ btn.dataset._t=btn.textContent; btn.disabled=true; btn.textContent=label; } else { btn.disabled=false; btn.textContent=idle||btn.dataset._t||btn.textContent; } };
  const withTimeout = (p, ms, tag) => Promise.race([ p, new Promise((_,rej)=> setTimeout(()=> rej(new Error(`timeout:${tag||'op'}}:${ms}ms`)), ms)) ]);

  // Date helpers
  const toLocalDateStr = d=>{
    const dt = (d instanceof Date)? d : new Date(d);
    dt.setMinutes(dt.getMinutes() - dt.getTimezoneOffset());
    return dt.toISOString().slice(0,10);
  };
  const addDaysStr = (days)=>{ const dt = new Date(); dt.setDate(dt.getDate()+days); return toLocalDateStr(dt); };
  const todayStr = ()=> toLocalDateStr(new Date());
  const diffDays = (dateStr)=>{
    if (!dateStr) return null;
    const a = new Date(toLocalDateStr(new Date()));
    const b = new Date(dateStr+'T00:00:00');
    return Math.round((b - a) / 86400000);
  };

  // Global error hooks
  window.addEventListener('error', e=>{ dbg('onerror', e.message, e.filename+':'+e.lineno+':'+e.colno); });
  window.addEventListener('unhandledrejection', e=>{ dbg('unhandledrejection', e.reason?.message || String(e.reason)); });

  if (DEBUG) { $('debug')?.classList.remove('hidden'); if(dbgUrl) dbgUrl.textContent = location.href; }
  on($('btnShowDebug'), 'click', ()=> { $('debug')?.classList.remove('hidden'); dbg('UI btnShowDebug clicked'); });
  if (DEBUG) {
    window.addEventListener('click', (e)=>{
      const id = e.target.id || '(no id)'; const btn = e.target.closest('button');
      dbg('CLICK', { id, tag: e.target.tagName, buttonId: btn?.id || null });
    }, { capture:true });
  }

  // Supabase client
  dbg('Creating clientâ€¦');
  const supa = window.supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON, {
    auth: { persistSession:true, detectSessionInUrl:true, flowType:'pkce' }
  });

  // DOM refs (single declaration!)
  const authCard=$('authCard'), app=$('app'), roleBadge=$('roleBadge'), userEmail=$('userEmail'), orgHint=$('orgHint');
  const inBarcode=$('inBarcode'), inName=$('inName'), inUnit=$('inUnit'), inPack=$('inPack'), inExpiry=$('inExpiry'), inPhoto=$('inPhoto'), photoName=$('photoName');
  const tblBody=$('tblBody'), btnExport=$('btnExport'), lblImport=$('lblImport'), inImport=$('inImport');
  const scanModal=$('scanModal'), scanVideo=$('scanVideo'), btnAdd=$('btnAdd');
  const tabCatalogue=$('tabCatalogue'), tabReorder=$('tabReorder'), pageCatalogue=$('pageCatalogue'), pageReorder=$('pageReorder');
  const btnFindExpiring=$('btnFindExpiring'), reDays=$('reDays'), reShowExpired=$('reShowExpired'), reSearch=$('reSearch'), tblExpiring=$('tblExpiring');

  // Session cache
  let currentUser = null;
  let profile=null, isAdmin=false, rows=[];
  // Scanner state (single declaration)
  let stream=null, detector=null, scanning=false, scanRAF=null;

  // Boot
  dbg('Page load. href=', location.href);
  async function boot() {
    const ses = await withTimeout(supa.auth.getSession(), 3000, 'getSession@boot');
    const session = ses?.data?.session || null;
    dbg('Initial getSession -> has user?', !!session?.user);
    if (session?.user) {
      currentUser = session.user;
      await onSignedIn(session.user);
    }
  }

  supa.auth.onAuthStateChange(async (event, session) => {
    dbg('onAuthStateChange', { event, hasSession: !!session });
    if (session?.user) {
      currentUser = session.user;
      await onSignedIn(session.user);
    }
  });

  async function onSignedIn(user){
    dbg('onSignedIn start', { userId: user.id });
    currentUser = user;
    authCard.classList.add('hidden'); app.classList.remove('hidden');
    try{
      const pr = await withTimeout(
        supa.from('profiles').select('id,email,role,org_id').eq('id', user.id).maybeSingle(),
        4000, 'profiles.select'
      );
      if (pr.error) dbg('profiles.select ERR', pr.error.message||pr.error);
      if (!pr.data) {
        dbg('profiles.upsert (create self profile)');
        const up = await withTimeout(
          supa.from('profiles').upsert({ id:user.id, email:user.email }).select().single(),
          4000, 'profiles.upsert'
        );
        if (up.error) dbg('profiles.upsert ERR', up.error.message||up.error);
      }
      const p2 = pr.data || { id:user.id, email:user.email, role:'user', org_id:null };
      profile = p2; isAdmin = p2.role === 'admin';
      userEmail.textContent = p2.email || 'signed in'; userEmail.classList.remove('hidden');
      roleBadge.textContent = isAdmin ? 'Admin' : 'User'; roleBadge.classList.remove('hidden');
      orgHint.textContent = p2.org_id ? `Org: ${String(p2.org_id).slice(0,8)}â€¦` : 'Org: â€”';
      lblImport.classList.toggle('hidden', !isAdmin);

      await refresh(); // initial load of catalogue
    }catch(e){ dbg('onSignedIn ERR', e.message||String(e)); }
  }

  // Auth buttons
  on($('btnMagic'), 'click', async ()=>{
    dbg('btnMagic clicked');
    const email = $('email').value.trim(); if(!email) return alert('Enter email');
    const { error } = await supa.auth.signInWithOtp({ email, options:{ emailRedirectTo: REDIRECT_URL } });
    if (error) { dbg('signInWithOtp ERR', error.message||error); return alert(error.message); }
    alert('Check your email for the sign-in link.');
  });

  on($('btnGoogle'), 'click', async ()=>{
    dbg('btnGoogle clicked');
    const { error } = await supa.auth.signInWithOAuth({ provider:'google', options:{ redirectTo: REDIRECT_URL, queryParams:{ prompt:'select_account' } } });
    if (error) { dbg('signInWithOAuth ERR', error.message||error); alert(error.message); }
  });

  async function signOutAndReset(tag){
    dbg(tag,'clicked');
    try { supa.auth.signOut(); } catch(e){ dbg('signOut ERR', e.message||e); }
    try { localStorage.clear(); sessionStorage.clear(); } catch{}
    location.replace(REDIRECT_URL);
  }
  on($('btnReset'), 'click', ()=>signOutAndReset('btnReset'));
  on($('btnInAppReset'), 'click', ()=>signOutAndReset('btnInAppReset'));
  on($('btnSignOut'), 'click', ()=>signOutAndReset('btnSignOut'));

  // Tabs
  function activateTab(which){
    tabCatalogue.classList.toggle('active', which==='cat');
    tabReorder.classList.toggle('active', which==='reo');
    pageCatalogue.classList.toggle('hidden', which!=='cat');
    pageReorder.classList.toggle('hidden', which!=='reo');
  }
  on(tabCatalogue, 'click', ()=> activateTab('cat'));
  on(tabReorder, 'click', ()=> activateTab('reo'));

  // Scanner (uses single declarations above)
  on($('btnScan'), 'click', async ()=>{
    scanModal.classList.remove('hidden'); scanModal.setAttribute('aria-hidden','false');
    try{
      if ('BarcodeDetector' in window) {
        if (!detector) detector = new window.BarcodeDetector({ formats: ['ean_13','ean_8','code_128','upc_a','upc_e','code_39','itf'] });
        stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' }, audio:false });
        scanVideo.srcObject = stream; await scanVideo.play();
        scanning=true; tickScan();
      } else { alert('BarcodeDetector not supported. Type the barcode manually.'); }
    }catch(e){ alert('Camera access failed. Type the barcode manually.'); }
  });
  on($('btnScanClose'), 'click', stopScan);
  function stopScan(){
    scanning=false; if (scanRAF) cancelAnimationFrame(scanRAF);
    if (scanVideo) { try{ scanVideo.pause(); }catch{} }
    if (stream) { stream.getTracks().forEach(t=>t.stop()); stream=null; }
    scanModal.classList.add('hidden'); scanModal.setAttribute('aria-hidden','true');
  }
  async function tickScan(){
    if (!scanning) return;
    try{
      const codes = await detector.detect(scanVideo);
      if (codes?.length) { inBarcode.value = codes[0].rawValue || codes[0].displayValue; stopScan(); }
    }catch(e){}
    scanRAF = requestAnimationFrame(tickScan);
  }

  // Photo input
  on(inPhoto, 'change', ()=>{ photoName.textContent = inPhoto.files?.[0]?.name || ''; });

  async function uploadPhoto(file, itemId) {
    if (!file) return null;
    const ext = (file.name.split('.').pop() || 'jpg').toLowerCase();
    const path = `${currentUser?.id || 'anon'}/${itemId}_${Date.now()}.${ext}`;
    const up = await withTimeout(supa.storage.from(STORAGE_BUCKET).upload(path, file, { upsert:false }), 7000, 'storage.upload');
    if (up.error) { alert('Photo upload failed: '+up.error.message); return null; }
    const pub = supa.storage.from(STORAGE_BUCKET).getPublicUrl(path);
    return pub?.data?.publicUrl || null;
  }

  // Save / Upsert
  on(btnAdd, 'click', async ()=>{
    setBusy(btnAdd, true, 'Savingâ€¦', 'Save / Upsert');
    try{
      const barcode = inBarcode.value.trim();
      const name    = inName.value.trim();
      const unit    = inUnit.value.trim() || null;
      const pack    = inPack.value.trim() || null;
      const expiry  = inExpiry.value ? inExpiry.value : null; // YYYY-MM-DD
      if (!currentUser) return alert('Not signed in');
      if (!barcode)    return alert('Barcode required');
      const lookup = await withTimeout(
        supa.from('catalogue').select('id').eq('barcode', barcode).limit(1).maybeSingle(),
        5000, 'lookup'
      );
      if (lookup.error) return alert('Lookup failed: '+lookup.error.message);
      const base = { barcode, unit, pack_size:pack, user_id:currentUser.id, expiry_date: expiry };
      if (!lookup.data && !name) return alert('Name required for new items');
      if (name) base.name = name;

      if (inPhoto.files?.[0]) {
        const tempId = lookup.data?.id || (crypto?.randomUUID ? crypto.randomUUID() : String(Date.now()));
        const photo_url = await uploadPhoto(inPhoto.files[0], tempId);
        if (photo_url) base.photo_url = photo_url;
      }

      if (lookup.data) {
        const upd = await withTimeout(
          supa.from('catalogue').update(base).eq('id', lookup.data.id).select().single(),
          6000, 'update'
        );
        if (upd.error) return alert('Update failed: '+upd.error.message);
      } else {
        const ins = await withTimeout(
          supa.from('catalogue').insert(base).select().single(),
          6000, 'insert'
        );
        if (ins.error) return alert('Insert failed: '+ins.error.message);
      }

      inBarcode.value=''; inName.value=''; inUnit.value=''; inPack.value=''; inExpiry.value=''; inPhoto.value=''; photoName.textContent='';
      await refresh();
    }catch(e){ alert('Save failed: '+(e.message||e)); }
    finally{ setBusy(btnAdd, false); }
  });

  // Fetch & render (Catalogue)
  async function refresh(){
    const q = await withTimeout(
      supa.from('v_catalogue_with_owner').select('*').order('updated_at',{ascending:false}).limit(1000),
      6000, 'view.select'
    );
    if (q.error) { alert('Load failed: '+q.error.message); return; }
    rows = q.data || [];
    renderCatalogue();
  }

  function editable(field, row) {
    const val = row[field] ?? '';
    const esc = String(val).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;');
    const type = (field === 'expiry_date') ? 'date' : 'text';
    return `<input ${type==='date'?'type="date"':''} data-edit="${row.id}" data-field="${field}" value="${esc}" />`;
  }

  function renderCatalogue(){
    const q = ($('inSearch').value||'').toLowerCase();
    const data = !q ? rows : rows.filter(r => (r.name||'').toLowerCase().includes(q) || (r.barcode||'').toLowerCase().includes(q));
    const tbody = tblBody; tbody.innerHTML='';
    for (const r of data) {
      const days = (typeof r.days_to_expiry === 'number' ? r.days_to_expiry : diffDays(r.expiry_date));
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.photo_url ? `<img src="${r.photo_url}" style="max-height:42px;border-radius:6px;border:1px solid rgba(255,255,255,.1)"/>` : ''}</td>
        <td class="mono">${r.barcode||''}</td>
        <td>${editable('name', r)}</td>
        <td>${editable('unit', r)}</td>
        <td>${editable('pack_size', r)}</td>
        <td>${editable('expiry_date', r)}</td>
        <td>${(days??'')}</td>
        <td>${r.owner_email||''}</td>
        <td><label class="file"><input type="file" accept="image/*" data-photo="${r.id}"/>Change photo</label></td>`;
      tbody.appendChild(tr);
    }
    // wire inline edits & photos
    tbody.querySelectorAll('input[data-edit]').forEach(inp=>{
      inp.addEventListener('keydown', e=>{ if(e.key==='Enter'){ onInlineEdit(e); }});
      inp.addEventListener('change', onInlineEdit);
    });
    tbody.querySelectorAll('input[data-photo]').forEach(inp=>{
      inp.addEventListener('change', onPhotoChange);
    });
  }

  async function onInlineEdit(e){
    const input = e.currentTarget;
    const id = input.getAttribute('data-edit');
    const field = input.getAttribute('data-field');
    let value = input.value.trim();
    if (field === 'name' && !value) { alert('Name is required'); return renderCatalogue(); }
    if (value === '') value = null;
    const payload={}; payload[field]=value;
    const res = await withTimeout(
      supa.from('catalogue').update(payload).eq('id', id).select().single(),
      6000, 'inline.update'
    );
    if (res.error) { alert(res.error.message); } else { await refresh(); }
  }

  async function onPhotoChange(e){
    const file = e.target.files?.[0]; if(!file) return;
    const id = e.target.getAttribute('data-photo');
    const url = await uploadPhoto(file, id);
    if (!url) return;
    const res = await withTimeout(
      supa.from('catalogue').update({ photo_url:url }).eq('id', id).select().single(),
      6000, 'photo.update'
    );
    if (res.error) { alert(res.error.message); } else { await refresh(); }
  }

  // CSV export/import
  on(btnExport, 'click', ()=>{
    const header = ['barcode','name','unit','pack_size','expiry_date','owner_email'];
    const lines = [header.join(',')];
    for (const r of rows) {
      const vals = [r.barcode||'', r.name||'', r.unit||'', r.pack_size||'', r.expiry_date||'', r.owner_email||'']
        .map(v => `"${String(v).replace(/"/g,'""')}"`);
      lines.push(vals.join(','));
    }
    const blob = new Blob([lines.join('\n')], {type:'text/csv'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'catalogue.csv'; a.click(); URL.revokeObjectURL(a.href);
  });

  on(inImport, 'change', async (e)=>{
    if (!isAdmin) { alert('Only admin can import.'); return; }
    const file = e.target.files?.[0]; if(!file) return;
    const txt = await file.text();
    const lines = txt.split(/\r?\n/).filter(Boolean);
    const header = lines.shift(); if(!header) return alert('Empty CSV');
    const cols = header.split(',').map(s=>s.replace(/^"|"$/g,''));
    const idx = {
      barcode:   cols.indexOf('barcode'),
      name:      cols.indexOf('name'),
      unit:      cols.indexOf('unit'),
      pack_size: cols.indexOf('pack_size'),
      expiry_date: cols.indexOf('expiry_date'),
    };
    if (idx.barcode<0) return alert('CSV must include "barcode" column');
    const user = currentUser;
    let ok=0, fail=0;
    for (const line of lines) {
      const parts = line.match(/("([^"]|"")*"|[^,]+)/g) || [];
      const unq = s => (s||'').replace(/^"|"$/g,'').replace(/""/g,'"');
      const payload = { barcode: unq(parts[idx.barcode]), user_id: user.id };
      if (idx.name>=0) payload.name = unq(parts[idx.name])||null;
      if (idx.unit>=0) payload.unit = unq(parts[idx.unit])||null;
      if (idx.pack_size>=0) payload.pack_size = unq(parts[idx.pack_size])||null;
      if (idx.expiry_date>=0) payload.expiry_date = unq(parts[idx.expiry_date])||null;
      if (!payload.barcode) { fail++; continue; }
      const up = await withTimeout(supa.from('catalogue').upsert(payload, { onConflict:'barcode' }), 6000, 'csv.upsert');
      if (up.error) fail++; else ok++;
    }
    alert(`Import complete: ${ok} ok, ${fail} failed`); await refresh();
  });

  // Re-Ordering: find expiring items
  on(btnFindExpiring, 'click', ()=> loadExpiring());
  on(reSearch, 'input', ()=> renderExpiringCache());
  on(reShowExpired, 'change', ()=> loadExpiring());

  let expiringCache = [];
  async function loadExpiring(){
    const days = Math.max(1, Number(reDays.value||60));
    const today = todayStr();
    const until = addDaysStr(days);
    const showExpired = reShowExpired.checked;

    let q = supa.from('v_catalogue_with_owner').select('*').order('expiry_date',{ascending:true});
    q = q.lte('expiry_date', until);
    if (!showExpired) q = q.gte('expiry_date', today);
    const res = await withTimeout(q, 6000, 'expiring.select');
    if (res.error) { alert('Fetch failed: '+res.error.message); return; }
    expiringCache = res.data || [];
    renderExpiringCache();
  }

  function renderExpiringCache(){
    const term = (reSearch.value||'').toLowerCase();
    const data = !term ? expiringCache :
      expiringCache.filter(r => (r.name||'').toLowerCase().includes(term) || (r.barcode||'').toLowerCase().includes(term));
    const tb = tblExpiring; tb.innerHTML='';
    for (const r of data) {
      const days = (typeof r.days_to_expiry === 'number' ? r.days_to_expiry : diffDays(r.expiry_date));
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="mono">${r.barcode||''}</td>
        <td>${r.name||''}</td>
        <td>${r.unit||''}</td>
        <td>${r.pack_size||''}</td>
        <td>${r.expiry_date||''}</td>
        <td>${(days??'')}</td>
        <td>${r.owner_email||''}</td>`;
      tb.appendChild(tr);
    }
  }

  // Start
  boot();

})();
</script>
</body>
</html>
