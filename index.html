<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dental Inventory (SaaS)</title>
  <style>
    :root{--bg:#0b1220;--card:#0f172a;--line:#1f2937;--text:#e5e7eb;--muted:#94a3b8}
    *{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Segoe UI,Roboto,Inter,Arial}
    header{position:sticky;top:0;background:rgba(11,18,32,.8);backdrop-filter:blur(6px);border-bottom:1px solid var(--line);z-index:5}
    .wrap{max-width:1100px;margin:0 auto;padding:12px 16px}
    h1{font-size:18px;margin:4px 0}.muted{color:var(--muted)}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;margin-top:12px}
    input,select,button{font:inherit}
    input,select{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px;background:#0b1220;color:var(--text)}
    button{padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:#111827;color:#e5e7eb;cursor:pointer}
    button.primary{background:linear-gradient(180deg,#16a34a,#15803d);border-color:#166534}
    button.warn{background:linear-gradient(180deg,#f59e0b,#d97706);border-color:#b45309}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid var(--line);text-align:left}
    th{color:#cbd5e1}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tabs button{border-radius:999px}
    .tabs .active{background:#1f2937}
    .tag{font-size:11px;padding:2px 8px;border-radius:999px;border:1px solid var(--line)}
    .camera{aspect-ratio:16/10;background:#000;border-radius:12px;overflow:hidden;border:1px solid var(--line)}
    @media print { header,.tabs,#view-scan,#view-catalog,#view-trans{display:none} #view-reorder{display:block} body{background:#fff;color:#000} table,th,td{border:1px solid #000} }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- ZXing fallback for iOS/Safari camera scanning -->
  <script src="https://unpkg.com/@zxing/library@latest"></script>
</head>
<body>
<header>
  <div class="wrap" style="display:flex;gap:8px;align-items:center">
    <div>
      <h1>Dental Inventory</h1>
      <div class="muted" id="status">Not signed in</div>
    </div>
    <div style="margin-left:auto; display:flex; gap:8px">
      <button id="btnSignOut" class="warn" style="display:none">Sign out</button>
    </div>
  </div>
</header>
<div class="wrap">
  <div class="card" id="authCard">
    <h3>Sign in / Sign up</h3>
    <div class="row">
      <div style="flex:1 1 260px"><label>Email</label><input id="email" type="email" placeholder="you@clinic.com"></div>
      <div style="flex:1 1 200px"><label>Password</label><input id="password" type="password" placeholder="••••••••"></div>
    </div>
    <div style="display:flex; gap:8px; margin-top:8px">
      <button class="primary" id="btnSignIn">Sign in</button>
      <button id="btnSignUp">Create account</button>
      <button id="btnGoogle">Sign in with Google</button>
      <span class="muted" style="margin-left:auto">Each account is isolated (RLS)</span>
    </div>
  </div>

  <div class="tabs" id="tabs" style="display:none"></div>

  <div id="view-scan" class="card" style="display:none">
    <h3>Scan / Log transaction</h3>
    <div class="row">
      <div style="flex:2 1 320px">
        <div class="row">
          <div style="flex:2 1 260px"><label>Barcode</label><input id="scan-barcode" placeholder="Focus here and scan…"></div>
          <div style="flex:1 1 120px"><label>Qty</label><input id="scan-qty" type="number" value="1" min="1"></div>
          <div style="flex:1 1 160px"><label>Mode</label>
            <select id="scan-mode"><option value="IN">Receive (IN)</option><option value="OUT">Use (OUT)</option></select>
          </div>
        </div>
        <div style=\"display:flex; gap:8px; margin-top:8px; align-items:center\">
          <button class=\"primary\" id=\"btnAddTx\">Add Transaction<\/button>
          <button id=\"btnCamera\">Use Camera (beta)<\/button>
          <button id=\"btnStopCam\" class=\"warn\" style=\"display:none\">Stop Camera<\/button>
          <label class=\"muted\" style=\"display:flex;gap:6px;align-items:center;margin-left:8px\"><input type=\"checkbox\" id=\"auto-add\" checked> Auto‑add when scanned<\/label>
        <\/div>
        <div class="camera" id="camWrap" style="display:none; margin-top:8px"><video id="video" autoplay muted playsinline style="width:100%;height:100%;object-fit:cover"></video></div>
      </div>
      <div style="flex:1 1 240px">
        <div class="muted">Matched Item</div>
        <div id="match">—</div>
      </div>
    </div>
  </div>

  <div id="view-catalog" class="card" style="display:none">
    <div style="display:flex; align-items:center; gap:8px"><h3>Catalog</h3><span class="muted" style="margin-left:auto">On‑hand comes from your transactions</span></div>
    <div class="row">
      <div style="flex:2 1 260px"><label>Barcode</label><input id="cat-barcode" placeholder="9300632083503"></div>
      <div style="flex:3 1 260px"><label>Item Name</label><input id="cat-name" placeholder="Colgate Optic White"></div>
      <div style="flex:1 1 120px"><label>Pack</label><input id="cat-pack" placeholder="1"></div>
      <div style="flex:1 1 120px"><label>Min Stock</label><input id="cat-min" type="number" placeholder="12"></div>
      <div style="flex:2 1 200px"><label>Supplier</label><input id="cat-supplier" placeholder="Supplier"></div>
    </div>
    <div style="display:flex; gap:8px; margin-top:8px">
      <button class="primary" id="btnUpsertItem">Add / Update Item</button>
      <button id="btnClearItem">Clear</button>
    </div>
    <div style="overflow:auto;max-height:360px;margin-top:8px">
      <table id="tbl-inv"><thead><tr><th>Barcode</th><th>Item</th><th>Pack</th><th>On‑hand</th><th>Min</th><th>Supplier</th><th></th></tr></thead><tbody></tbody></table>
    </div>
  </div>

  <div id="view-reorder" class="card" style="display:none">
    <div style="display:flex; gap:8px; align-items:center"><h3>Reorder</h3><button class="right" id="btnPrint">Print Reorder Sheet</button></div>
    <div style="overflow:auto;max-height:320px">
      <table id="tbl-reo"><thead><tr><th>Barcode</th><th>Item</th><th>On‑hand</th><th>Min</th><th>Supplier</th></tr></thead><tbody></tbody></table>
    </div>
  </div>

  <div id="view-trans" class="card" style="display:none">
    <div style="display:flex; gap:8px; align-items:center"><h3>Transactions</h3><button class="right" id="btnReload">Reload</button></div>
    <div style="overflow:auto;max-height:420px">
      <table id="tbl-tx"><thead><tr><th>Date/Time</th><th>Action</th><th>Barcode</th><th>Item</th><th>Qty</th><th>Staff</th></tr></thead><tbody></tbody></table>
    </div>
  </div>

</div>

<script>
// ======= CONFIG (yours) =======
const SUPABASE_URL = 'https://sgjoadsefpcixvmthtfy.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNnam9hZHNlZnBjaXh2bXRodGZ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwMDIyMjYsImV4cCI6MjA3NDU3ODIyNn0.UcmAuHzEtKZIBs0pGkcLyRIYcLzCA4tNfuuDkUVLpU8';
// ==============================

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
let currentUser = null;

const $ = (s)=>document.querySelector(s);
function setTabsVisible(v){ $('#tabs').style.display = v?'flex':'none'; }
function showView(id){ ['view-scan','view-catalog','view-reorder','view-trans'].forEach(x=>{ document.getElementById(x).style.display = (x===id)?'block':'none';}); }
function setSignedInUI(signed){
  $('#authCard').style.display = signed?'none':'block';
  setTabsVisible(signed);
  $('#status').textContent = signed? ('Signed in: '+(currentUser?.email||'')) : 'Not signed in';
  $('#btnSignOut').style.display = signed?'inline-block':'none';
  if(signed){ $('#scan-barcode').focus(); }
}

(function buildTabs(){
  const tabs=[
    {id:'view-scan', label:'Scan'},
    {id:'view-catalog', label:'Catalog'},
    {id:'view-reorder', label:'Reorder'},
    {id:'view-trans', label:'Transactions'}
  ];
  const c=$('#tabs'); c.innerHTML='';
  tabs.forEach((t,i)=>{ const b=document.createElement('button'); b.textContent=t.label; b.className=i?'' :'active'; b.addEventListener('click',()=>{ c.querySelectorAll('button').forEach(x=>x.classList.remove('active')); b.classList.add('active'); showView(t.id); }); c.appendChild(b); });
})();

async function signUp(){ const {error} = await sb.auth.signUp({ email: $('#email').value.trim(), password: $('#password').value}); if(error) alert(error.message); else alert('Check your inbox to confirm, then sign in.'); }
async function signIn(){ const {error} = await sb.auth.signInWithPassword({ email: $('#email').value.trim(), password: $('#password').value}); if(error) alert(error.message); }
async function signOut(){ await sb.auth.signOut(); }

document.getElementById('btnGoogle').addEventListener('click', async ()=>{
  const { error } = await sb.auth.signInWithOAuth({
    provider: 'google',
    options: { redirectTo: 'https://dentalcount.github.io/dental-inventory/' }
  });
  if (error) alert(error.message);
});

sb.auth.onAuthStateChange(async (_evt, sess)=>{ currentUser = sess?.user || null; setSignedInUI(!!currentUser); if(currentUser){ await loadAll(); }});

async function upsertItem(){
  if(!currentUser) return;
  const ins = {
    user_id: currentUser.id,
    barcode: $('#cat-barcode').value.trim(),
    item_name: $('#cat-name').value.trim(),
    pack_size: $('#cat-pack').value.trim(),
    min_stock: Number($('#cat-min').value||0),
    supplier: $('#cat-supplier').value.trim()
  };
  if(!ins.barcode) return alert('Barcode required');
  const {error} = await sb.from('items').upsert(ins, { onConflict: 'user_id,barcode' });
  if(error) return alert(error.message);
  await loadItems();
  $('#cat-name').value=''; $('#cat-pack').value=''; $('#cat-min').value=''; $('#cat-supplier').value='';
}

async function addTx(){
  if(!currentUser) return; const bc=$('#scan-barcode').value.trim(); if(!bc) return alert('Scan a barcode');
  const qty=Number($('#scan-qty').value||1); if(qty<=0) return alert('Qty > 0');
  const action=$('#scan-mode').value;
  await sb.from('items').upsert({user_id: currentUser.id, barcode: bc});
  const {error} = await sb.from('transactions').insert({ user_id: currentUser.id, action, barcode: bc, quantity: qty, staff: ''});
  if(error) return alert(error.message);
  $('#scan-barcode').value=''; $('#scan-qty').value=1; $('#scan-barcode').focus();
  await Promise.all([loadItems(), loadTx()]);
}

async function loadItems(){
  const {data, error} = await sb.from('items').select('*').order('item_name', {ascending:true});
  if(error) { alert(error.message); return; }
  const tbody=$('#tbl-inv tbody'); tbody.innerHTML='';
  const oh = await onHandMap();
  for(const it of data){
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${it.barcode}</td><td>${it.item_name||''}</td><td>${it.pack_size||''}</td><td>${oh[it.barcode]||0}</td><td>${it.min_stock||0}</td><td>${it.supplier||''}</td><td><button data-bc="${it.barcode}">Delete</button></td>`;
    tbody.appendChild(tr);
  }
  tbody.querySelectorAll('button').forEach(btn=>{
    btn.addEventListener('click', async()=>{ if(confirm('Delete item '+btn.dataset.bc+'?')){ await sb.from('items').delete().eq('user_id', currentUser.id).eq('barcode', btn.dataset.bc); await loadAll(); }});
  });
  await buildReorder(oh, data);
  const bc=$('#scan-barcode').value.trim();
  const m = data.find(x=>x.barcode===bc);
  $('#match').innerHTML = m? `<b>${m.item_name||'—'}</b><br><span class="muted">Pack: ${m.pack_size||'-'} • Supplier: ${m.supplier||'-'}</span><br>On‑hand: <b>${(oh[bc]||0)}</b>` : '—';
  for(const it of data){
    const cur = oh[it.barcode]||0; const min = Number(it.min_stock||0);
    if(min>0 && cur<min){ alert(`⚠️ Low stock: ${it.item_name||it.barcode} (On‑hand: ${cur}, Min: ${min})`); }
  }
}

async function loadTx(){
  const {data, error} = await sb.from('transactions').select('*').order('ts', {ascending:false}).limit(500);
  if(error){ alert(error.message); return; }
  const tbody=$('#tbl-tx tbody'); tbody.innerHTML='';
  const items = await listItemsMap();
  for(const t of data){
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${new Date(t.ts).toLocaleString()}</td><td><span class="tag">${t.action}</span></td><td>${t.barcode}</td><td>${items[t.barcode]?.item_name||''}</td><td>${t.quantity}</td><td>${t.staff||''}</td>`;
    tbody.appendChild(tr);
  }
}

async function onHandMap(){
  const {data, error} = await sb.from('transactions').select('action, barcode, quantity');
  if(error) { alert(error.message); return {}; }
  const map={};
  for(const r of data){ if(!map[r.barcode]) map[r.barcode]=0; map[r.barcode]+= (r.action==='IN'? +r.quantity : -r.quantity); }
  return map;
}

async function listItemsMap(){
  const {data} = await sb.from('items').select('barcode,item_name,pack_size,supplier');
  const m={}; (data||[]).forEach(x=>m[x.barcode]=x); return m;
}

async function buildReorder(oh, items){
  const tbody=$('#tbl-reo tbody'); tbody.innerHTML='';
  for(const it of items){
    const cur = oh[it.barcode]||0; const min = Number(it.min_stock||0);
    if(min>0 && cur<min){
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${it.barcode}</td><td>${it.item_name||''}</td><td>${cur}</td><td>${min}</td><td>${it.supplier||''}</td>`;
      tbody.appendChild(tr);
    }
  }
}

let stream=null; let zxingReader=null; const supportsBarcode = 'BarcodeDetector' in window;
// auto-add support
let lastScanText = ''; const AUTO_ADD_DELAY = 600;
function maybeAutoAdd(text){
  const cb = document.getElementById('auto-add');
  if(!cb || !cb.checked) return;
  if(!text || text === lastScanText) return;
  lastScanText = text;
  const snapshot = text;
  setTimeout(()=>{
    if(document.getElementById('scan-barcode').value.trim() === snapshot){ addTx(); }
  }, AUTO_ADD_DELAY);
}
async function startCamera(){
  try{
    // Open camera
    stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
    const v=$('#video'); v.srcObject=stream; await v.play();
    $('#camWrap').style.display='block'; $('#btnStopCam').style.display='inline-block';

    if(supportsBarcode){
      // Fast native API (Chrome/Android)
      const det=new BarcodeDetector({formats:['ean_13','upc_a','code_128','code_39','ean_8','itf']});
      const loop=async()=>{ if(!stream) return; try{ const codes=await det.detect(v); if(codes.length){ const val=codes[0].rawValue; $('#scan-barcode').value = val; maybeAutoAdd(val); } }catch(e){} requestAnimationFrame(loop); };
      loop();
    } else if(window.ZXing){
      // ZXing fallback (iOS/Safari)
      zxingReader = new ZXing.BrowserMultiFormatReader();
      await zxingReader.decodeFromVideoDevice(null, 'video', (result, err) => {
        if(result){ const val = result.getText(); $('#scan-barcode').value = val; maybeAutoAdd(val); }
        // ignore continuous decode errors while scanning
      });
    } else {
      alert('Camera scanning not supported on this browser. Use a Bluetooth scanner.');
    }
  }catch(e){ alert('Camera error: '+e.message); }
}
function stopCamera(){
  try{ if(zxingReader){ zxingReader.reset(); zxingReader=null; } }catch(e){}
  if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
  $('#camWrap').style.display='none'; $('#btnStopCam').style.display='none';

async function loadAll(){ await Promise.all([loadItems(), loadTx()]); }

// Hook up events
$('#btnSignUp').addEventListener('click', signUp);
$('#btnSignIn').addEventListener('click', signIn);
$('#btnSignOut').addEventListener('click', signOut);
$('#btnUpsertItem').addEventListener('click', upsertItem);
$('#btnClearItem').addEventListener('click', ()=>{ ['#cat-barcode','#cat-name','#cat-pack','#cat-min','#cat-supplier'].forEach(s=>$(s).value=''); });
$('#btnAddTx').addEventListener('click', addTx);
$('#scan-barcode').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ addTx(); }});
$('#btnReload').addEventListener('click', loadAll);
$('#btnPrint').addEventListener('click', ()=>window.print());
$('#btnCamera').addEventListener('click', startCamera);
$('#btnStopCam').addEventListener('click', stopCamera);
</script>
</body>
</html>
