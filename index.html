<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Dental Inventory</title>
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3EðŸ¦·%3C/text%3E%3C/svg%3E">
<script src="https://unpkg.com/@supabase/supabase-js@2.44.4/dist/umd/supabase.js"></script>
<style>
  :root{--muted:#94a3b8;--text:#e5e7eb;--bg:#0b1220;--panel:#0c1426;--border:rgba(255,255,255,.10);--accent:#22d3ee}
  html,body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .wrap{max-width:1100px;margin:0 auto;padding:20px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px;margin:14px 0}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
  input,button,select{width:100%;padding:.7rem .8rem;border-radius:12px;border:1px solid var(--border);background:#0d1526;color:#e5e7eb;outline:none}
  input:focus,select:focus{border-color:var(--accent)}
  .btn{cursor:pointer;border:none}
  .btn[disabled]{opacity:.6;cursor:not-allowed}
  .btn.primary{background:linear-gradient(90deg,#00c2ff,#14f1d9);color:#022;font-weight:700}
  .btn.alt{background:#1f2937}
  .hidden{display:none!important}
  table{width:100%;border-collapse:separate;border-spacing:0 8px}
  th,td{padding:.6rem .55rem;text-align:left}
  thead th{font-size:.85rem;color:var(--muted)}
  tbody tr{background:#0d1629;border:1px solid rgba(255,255,255,.08)}
  tbody tr td:first-child{border-top-left-radius:10px;border-bottom-left-radius:10px}
  tbody tr td:last-child{border-top-right-radius:10px;border-bottom-right-radius:10px}
  .badge{padding:.2rem .5rem;border-radius:999px;border:1px solid var(--border);font-size:.75rem}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;}
  #debug{position:fixed;left:0;right:0;bottom:0;max-height:46vh;overflow:auto;background:#0a0f1d;border-top:1px solid var(--border);font-size:12px;z-index:40}
  #dbgHead{display:flex;gap:8px;align-items:center;padding:8px;border-bottom:1px solid var(--border)}
  #dbgBody{padding:8px}
  pre{white-space:pre-wrap;font-family:ui-monospace,Menlo,Consolas,monospace;margin:0}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:50}
  .sheet{background:#0b1220;border:1px solid var(--border);border-radius:16px;padding:16px;max-width:680px;width:92%}
  video{width:100%;max-height:300px;background:#000;border-radius:12px;border:1px solid var(--border)}
  .hint{color:var(--muted);font-size:.85rem}
  .file{display:inline-block;padding:.5rem .7rem;border:1px dashed var(--border);border-radius:8px;background:#101830;cursor:pointer}
  .file input{display:none}
</style>
</head>
<body>
<div class="wrap">
  <h1 style="display:flex;justify-content:space-between;align-items:center">
    <span>Dental Inventory <span id="roleBadge" class="badge hidden"></span></span>
    <span style="display:flex;gap:8px;align-items:center">
      <span id="userEmail" class="badge hidden"></span>
      <button id="btnShowDebug" class="btn alt">Show Debug</button>
      <button id="btnInAppReset" class="btn alt">Reset Session</button>
      <button id="btnSignOut" class="btn alt">Sign out</button>
    </span>
  </h1>

  <!-- Auth -->
  <div id="authCard" class="card">
    <div class="row">
      <div><input id="email" type="email" placeholder="you@clinic.com"/></div>
      <div style="align-self:end"><button id="btnMagic" class="btn primary">Send Magic Link</button></div>
    </div>
    <div class="row" style="margin-top:8px">
      <div><button id="btnGoogle" class="btn alt">Continue with Google</button></div>
      <div><button id="btnReset" class="btn alt">Reset Session</button></div>
    </div>
    <div class="hint" style="margin-top:8px">If Google shows the account chooser then returns here, thatâ€™s expectedâ€”PKCE finishes the sign-in on this page.</div>
  </div>

  <!-- App -->
  <div id="app" class="hidden">
    <div class="card">
      <div class="row3">
        <div>
          <div style="display:flex;gap:8px">
            <input id="inBarcode" class="mono" placeholder="Scan or type barcodeâ€¦"/>
            <button id="btnScan" class="btn alt" style="width:auto">ðŸ“· Scan</button>
          </div>
        </div>
        <div><input id="inName" placeholder="Item Name (required for new)"/></div>
        <div><input id="inUnit" placeholder="Unit (e.g., box / pack / ea)"/></div>
      </div>
      <div class="row3" style="margin-top:8px">
        <div><input id="inPack" placeholder="Pack size (e.g., x10 / 50pcs / 3g)"/></div>
        <div>
          <label class="file"><input id="inPhoto" type="file" accept="image/*" capture="environment"/>Upload Photo</label>
          <span id="photoName" class="hint" style="margin-left:8px"></span>
        </div>
        <div style="align-self:end"><button id="btnAdd" class="btn primary">Save / Upsert</button></div>
      </div>
    </div>

    <div class="card">
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
        <input id="inSearch" placeholder="Search name or barcodeâ€¦" class="mono" style="flex:1 1 280px"/>
        <button id="btnRefresh" class="btn">Refresh</button>
        <button id="btnExport" class="btn">Export CSV</button>
        <label id="lblImport" class="file hidden"><input id="inImport" type="file" accept=".csv"/>Import CSV (admin)</label>
        <label class="hint" style="display:flex;gap:8px;align-items:center">
          <input id="chkAll" type="checkbox" disabled/> View all users
        </label>
        <span id="orgHint" class="badge"></span>
      </div>
      <div class="hint" style="margin-top:6px">Tip: click a field to edit inline. Press Enter to save.</div>
      <div style="overflow:auto;margin-top:8px">
        <table>
          <thead><tr><th>Photo</th><th>Barcode</th><th>Name</th><th>Unit</th><th>Pack</th><th>Owner</th><th>Actions</th></tr></thead>
          <tbody id="tblBody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Scanner Modal -->
<div id="scanModal" class="modal hidden" aria-hidden="true">
  <div class="sheet">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <strong>Barcode Scanner</strong>
      <button id="btnScanClose" class="btn alt" style="width:auto">Close</button>
    </div>
    <video id="scanVideo" playsinline></video>
    <div class="hint" style="margin-top:6px">If scanning doesnâ€™t start, type the barcode manually.</div>
  </div>
</div>

<!-- Debug Panel -->
<div id="debug" class="hidden">
  <div id="dbgHead">
    <button id="btnDbgRead" class="btn alt" style="width:auto">Perms: Read</button>
    <button id="btnDbgWrite" class="btn alt" style="width:auto">Perms: Write</button>
    <button id="btnDbgRaw" class="btn alt" style="width:auto">Raw REST</button>
    <span id="dbgStatus" style="margin-left:auto;color:#94a3b8"></span>
  </div>
  <div id="dbgBody">
    <div class="hint">URL: <span id="dbgUrl"></span></div>
    <pre id="log"></pre>
  </div>
</div>

<script>
(function(){
  /*** CONFIG ***/
  const REDIRECT_URL  = 'https://dentalcount.github.io/dental-inventory/';
  const SUPABASE_URL  = 'https://sgjoadsefpcixvmthtfy.supabase.co';
  const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNnam9hZHNlZnBjaXh2bXRodGZ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwMDIyMjYsImV4cCI6MjA3NDU3ODIyNn0.UcmAuHzEtKZIBs0pGkcLyRIYcLzCA4tNfuuDkUVLpU8';
  const STORAGE_BUCKET = 'product_photos';
  /***************/

  // Helpers & Debug
  const $ = id => document.getElementById(id);
  const qs = new URLSearchParams(location.search);
  const DEBUG = qs.get('debug') === '1' || location.search.includes('?code=');
  const logEl = $('log'), dbgUrl = $('dbgUrl');

  const ts = ()=> new Date().toISOString().split('T')[1].replace('Z','');
  const dbg = (...a)=>{ console.log('[DBG]', ...a); if(DEBUG&&logEl){ logEl.textContent += `[${ts()}] `+ a.map(x=>typeof x==='string'?x:JSON.stringify(x)).join(' ') + '\n'; } };
  const on = (el, ev, fn)=>{ if(!el){ if(DEBUG) dbg('wire skipped (missing element)'); return; } el.addEventListener(ev, fn, { passive:true }); };
  const setBusy = (btn,on,label='Workingâ€¦',idle)=>{ if(!btn) return; if(on){ btn.dataset._t=btn.textContent; btn.disabled=true; btn.textContent=label; } else { btn.disabled=false; btn.textContent=idle||btn.dataset._t||btn.textContent; } };

  // Promise race with timeout (prevents hangs)
  const withTimeout = (p, ms, tag) => Promise.race([
    p,
    new Promise((_,rej)=> setTimeout(()=> rej(new Error(`timeout:${tag||'op'}:${ms}ms`)), ms))
  ]);

  // Global error hooks
  window.addEventListener('error', e=>{ dbg('onerror', e.message, e.filename+':'+e.lineno+':'+e.colno); });
  window.addEventListener('unhandledrejection', e=>{ dbg('unhandledrejection', e.reason?.message || String(e.reason)); });

  if (DEBUG) { $('debug')?.classList.remove('hidden'); if(dbgUrl) dbgUrl.textContent = location.href; }
  on($('btnShowDebug'), 'click', ()=> { $('debug')?.classList.remove('hidden'); dbg('UI btnShowDebug clicked'); });
  if (DEBUG) {
    window.addEventListener('click', (e)=>{
      const id = e.target.id || '(no id)'; const btn = e.target.closest('button');
      dbg('CLICK', { id, tag: e.target.tagName, buttonId: btn?.id || null });
    }, { capture:true });
  }

  // Supabase client
  dbg('Creating clientâ€¦');
  const supa = window.supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON, {
    auth: { persistSession:true, detectSessionInUrl:true, flowType:'pkce' }
  });

  // DOM refs
  const authCard=$('authCard'), app=$('app'), roleBadge=$('roleBadge'), userEmail=$('userEmail'), orgHint=$('orgHint');
  const inBarcode=$('inBarcode'), inName=$('inName'), inUnit=$('inUnit'), inPack=$('inPack'), inPhoto=$('inPhoto'), photoName=$('photoName');
  const tblBody=$('tblBody'), chkAll=$('chkAll'), btnExport=$('btnExport'), lblImport=$('lblImport'), inImport=$('inImport');
  const scanModal=$('scanModal'), scanVideo=$('scanVideo'); const btnAdd=$('btnAdd');

  // Session cache (critical change)
  let currentUser = null;   // { id, email, ... }
  let profile=null, isAdmin=false, rows=[], stream=null, detector=null, scanning=false, scanRAF=null;

  function killOverlays(){
    if (scanModal) scanModal.classList.add('hidden');
    if (scanVideo && !scanVideo.paused) { try { scanVideo.pause(); } catch{} }
    if (stream) { stream.getTracks().forEach(t=>t.stop()); stream=null; }
  }

  dbg('Page load. hasReturn=', location.search.includes('?code='), 'href=', location.href);

  async function boot() {
    const hasReturn = location.search.includes('?code=');
    dbg('Return handler start. hasReturn=', hasReturn, 'href=', location.href);
    killOverlays();
    const { data: { session } } = await withTimeout(supa.auth.getSession(), 3000, 'getSession@boot');
    dbg('Initial getSession -> has user?', !!session?.user);
    if (session?.user) {
      currentUser = session.user;
      await onSignedIn(session.user);
      if (hasReturn) history.replaceState({}, '', REDIRECT_URL);
    }
  }

  supa.auth.onAuthStateChange(async (event, session) => {
    dbg('onAuthStateChange', { event, hasSession: !!session });
    if (session?.user) {
      currentUser = session.user;  // update cache immediately
      await onSignedIn(session.user);
    }
  });

  async function onSignedIn(user){
    dbg('onSignedIn start', { userId: user.id });
    currentUser = user; // ensure cache
    authCard.classList.add('hidden'); app.classList.remove('hidden');
    try{
      const pr = await withTimeout(
        supa.from('profiles').select('id,email,role,org_id').eq('id', user.id).maybeSingle(),
        4000, 'profiles.select'
      );
      if (pr.error) dbg('profiles.select ERR', pr.error.message||pr.error);
      if (!pr.data) {
        dbg('profiles.upsert (create self profile)');
        const up = await withTimeout(
          supa.from('profiles').upsert({ id:user.id, email:user.email }).select().single(),
          4000, 'profiles.upsert'
        );
        if (up.error) dbg('profiles.upsert ERR', up.error.message||up.error);
      }
      const p2 = pr.data || { id:user.id, email:user.email, role:'user', org_id:null };
      profile = p2; isAdmin = p2.role === 'admin';
      userEmail.textContent = p2.email || 'signed in'; userEmail.classList.remove('hidden');
      roleBadge.textContent = isAdmin ? 'Admin' : 'User'; roleBadge.classList.remove('hidden');
      orgHint.textContent = p2.org_id ? `Org: ${String(p2.org_id).slice(0,8)}â€¦` : 'Org: â€”';
      chkAll.disabled = !isAdmin; btnExport.disabled = false; lblImport.classList.toggle('hidden', !isAdmin);
      await refresh();
    }catch(e){ dbg('onSignedIn ERR', e.message||String(e)); }
  }

  // Auth buttons
  on($('btnMagic'), 'click', async ()=>{
    dbg('btnMagic clicked'); const email = $('email').value.trim(); if(!email) return alert('Enter email');
    const { error } = await supa.auth.signInWithOtp({ email, options:{ emailRedirectTo: REDIRECT_URL } });
    if (error) { dbg('signInWithOtp ERR', error.message||error); return alert(error.message); }
    alert('Check your email for the sign-in link.');
  });

  on($('btnGoogle'), 'click', async ()=>{
    dbg('btnGoogle clicked');
    const { error } = await supa.auth.signInWithOAuth({ provider:'google', options:{ redirectTo: REDIRECT_URL, queryParams:{ prompt:'select_account' } } });
    if (error) { dbg('signInWithOAuth ERR', error.message||error); alert(error.message); }
  });

  async function signOutAndReset(tag){
    dbg(tag,'clicked');
    try { supa.auth.signOut(); } catch(e){ dbg('signOut ERR', e.message||e); } // fire-and-forget
    try { localStorage.clear(); sessionStorage.clear(); } catch{}
    location.replace(REDIRECT_URL); // redirect immediately; no await chain
  }
  on($('btnReset'), 'click', ()=>signOutAndReset('btnReset'));
  on($('btnInAppReset'), 'click', ()=>signOutAndReset('btnInAppReset'));
  on($('btnSignOut'), 'click', ()=>signOutAndReset('btnSignOut'));

  // Scanner
  on($('btnScan'), 'click', async ()=>{
    dbg('btnScan clicked');
    scanModal.classList.remove('hidden'); scanModal.setAttribute('aria-hidden','false');
    try {
      if ('BarcodeDetector' in window) {
        if (!detector) detector = new window.BarcodeDetector({ formats: ['ean_13','ean_8','code_128','upc_a','upc_e','code_39','itf'] });
        stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' }, audio:false });
        scanVideo.srcObject = stream; await scanVideo.play();
        scanning = true; tickScan();
      } else {
        alert('BarcodeDetector not supported. Type the barcode manually.'); dbg('no BarcodeDetector');
      }
    } catch (e) {
      alert('Camera access failed. Type the barcode manually.'); dbg('scan start err', e.message||e);
    }
  });
  on($('btnScanClose'), 'click', ()=>{ dbg('btnScanClose clicked'); stopScan(); });
  function stopScan(){
    scanning=false; if (scanRAF) cancelAnimationFrame(scanRAF);
    if (scanVideo) { try{ scanVideo.pause(); }catch{} }
    if (stream) { stream.getTracks().forEach(t=>t.stop()); stream=null; }
    scanModal.classList.add('hidden'); scanModal.setAttribute('aria-hidden','true');
  }
  async function tickScan(){
    if (!scanning) return;
    try{
      const codes = await detector.detect(scanVideo);
      if (codes && codes.length>0) {
        const code = codes[0].rawValue || codes[0].displayValue;
        if (code) { inBarcode.value = code; dbg('scan detected', code); stopScan(); }
      }
    }catch(e){ }
    scanRAF = requestAnimationFrame(tickScan);
  }

  // Photo input
  on(inPhoto, 'change', ()=>{ photoName.textContent = inPhoto.files?.[0]?.name || ''; dbg('photo selected', photoName.textContent); });

  async function uploadPhoto(file, itemId) {
    if (!file) return null;
    const ext = (file.name.split('.').pop() || 'jpg').toLowerCase();
    const path = `${currentUser?.id || 'anon'}/${itemId}_${Date.now()}.${ext}`;
    const up = await withTimeout(supa.storage.from(STORAGE_BUCKET).upload(path, file, { upsert:false }), 7000, 'storage.upload');
    if (up.error) { dbg('photo upload ERR', up.error.message||up.error); alert('Photo upload failed: '+up.error.message); return null; }
    const pub = supa.storage.from(STORAGE_BUCKET).getPublicUrl(path);
    const url = pub?.data?.publicUrl || null; dbg('photo uploaded url', url);
    return url;
  }

  // Save / Upsert (NO getUser await; uses cached currentUser)
  on(btnAdd, 'click', async ()=>{
    dbg('btnAdd clicked.');
    setBusy(btnAdd, true, 'Savingâ€¦', 'Save / Upsert');

    try{
      const barcode = inBarcode.value.trim();
      const name    = inName.value.trim();
      const unit    = inUnit.value.trim() || null;
      const pack    = inPack.value.trim() || null;
      dbg('SAVE[1] inputs', { barcode, name, unit, pack, hasPhoto: !!(inPhoto.files?.[0]) });

      // Use cached user immediately
      const user = currentUser;
      dbg('SAVE[2] user', { hasUser: !!user, userId: user?.id });
      if (!user) { alert('Not signed in'); return; }
      if (!barcode) { alert('Barcode required'); return; }

      const lookup = await withTimeout(
        supa.from('catalogue').select('id').eq('barcode', barcode).limit(1).maybeSingle(),
        5000, 'lookup'
      );
      dbg('SAVE[3] lookup', { err: !!lookup.error, found: !!lookup.data, id: lookup.data?.id });
      if (lookup.error) { alert('Lookup failed: '+lookup.error.message); return; }

      const base = { barcode, unit, pack_size:pack, user_id:user.id };
      if (!lookup.data && !name) { alert('Name required for new items'); dbg('SAVE abort: name required'); return; }
      if (name) base.name = name;

      if (inPhoto.files?.[0]) {
        const tempId = lookup.data?.id || (window.crypto?.randomUUID ? crypto.randomUUID() : String(Date.now()));
        dbg('SAVE[4] uploading photoâ€¦', { tempId });
        const photo_url = await uploadPhoto(inPhoto.files[0], tempId);
        dbg('SAVE[4] photo url', photo_url);
        if (photo_url) base.photo_url = photo_url;
      }

      if (lookup.data) {
        dbg('SAVE[5] updating', { id: lookup.data.id, base });
        const upd = await withTimeout(
          supa.from('catalogue').update(base).eq('id', lookup.data.id).select().single(),
          6000, 'update'
        );
        dbg('SAVE[5] update result', { err: !!upd.error, id: upd.data?.id });
        if (upd.error) { alert('Update failed: '+upd.error.message); return; }
      } else {
        dbg('SAVE[5] inserting', base);
        const ins = await withTimeout(
          supa.from('catalogue').insert(base).select().single(),
          6000, 'insert'
        );
        dbg('SAVE[5] insert result', { err: !!ins.error, id: ins.data?.id });
        if (ins.error) { alert('Insert failed: '+ins.error.message); return; }
      }

      inBarcode.value=''; inName.value=''; inUnit.value=''; inPack.value=''; inPhoto.value=''; photoName.textContent='';
      dbg('SAVE[6] cleared inputs; refreshingâ€¦');
      await refresh();
      dbg('SAVE[7] done');

    }catch(e){
      dbg('SAVE[ERR]', e.message||String(e));
      alert('Save failed: '+(e.message||e));
    }finally{
      setBusy(btnAdd, false);
    }
  });

  // Fetch & render
  async function refresh(){
    dbg('refresh() start');
    const q = await withTimeout(
      supa.from('v_catalogue_with_owner').select('*').order('updated_at',{ascending:false}).limit(1000),
      6000, 'view.select'
    );
    if (q.error) { dbg('view.select ERR', q.error.message||q.error); return; }
    rows = q.data || []; dbg('refresh() rows', rows.length);
    render();
  }

  function editable(field, row) {
    const val = row[field] ?? '';
    const esc = String(val).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;');
    return `<input data-edit="${row.id}" data-field="${field}" value="${esc}" />`;
  }

  function render(){
    const q = ($('inSearch').value||'').toLowerCase();
    const data = !q ? rows : rows.filter(r => (r.name||'').toLowerCase().includes(q) || (r.barcode||'').toLowerCase().includes(q));
    tblBody.innerHTML='';
    for (const r of data) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.photo_url ? `<img src="${r.photo_url}" style="max-height:42px;border-radius:6px;border:1px solid rgba(255,255,255,.1)"/>` : ''}</td>
        <td class="mono">${r.barcode||''}</td>
        <td>${editable('name', r)}</td>
        <td>${editable('unit', r)}</td>
        <td>${editable('pack_size', r)}</td>
        <td>${r.owner_email||''}</td>
        <td><label class="file"><input type="file" accept="image/*" data-photo="${r.id}"/>Change photo</label></td>`;
      tblBody.appendChild(tr);
    }
    // wire inline edits & photos
    tblBody.querySelectorAll('input[data-edit]').forEach(inp=>{
      inp.addEventListener('keydown', e=>{ if(e.key==='Enter'){ onInlineEdit(e); }});
      inp.addEventListener('change', onInlineEdit);
    });
    tblBody.querySelectorAll('input[data-photo]').forEach(inp=>{
      inp.addEventListener('change', onPhotoChange);
    });
    dbg('render() done, rows on screen', data.length);
  }

  async function onInlineEdit(e){
    const input = e.currentTarget;
    const id = input.getAttribute('data-edit');
    const field = input.getAttribute('data-field');
    const value = input.value.trim() || null;
    dbg('inlineEdit', { id, field, value });
    if (field === 'name' && (!value || value.length===0)) { alert('Name is required'); return render(); }
    const payload={}; payload[field]=value;
    const res = await withTimeout(
      supa.from('catalogue').update(payload).eq('id', id).select().single(),
      6000, 'inline.update'
    );
    if (res.error) { dbg('inline edit ERR', res.error.message||res.error); alert(res.error.message); }
    else dbg('inline edit OK', {id, field});
  }

  async function onPhotoChange(e){
    const file = e.target.files?.[0]; if(!file) return;
    const id = e.target.getAttribute('data-photo');
    dbg('photo change', { id, name:file.name });
    const url = await uploadPhoto(file, id);
    if (!url) return;
    const res = await withTimeout(
      supa.from('catalogue').update({ photo_url:url }).eq('id', id).select().single(),
      6000, 'photo.update'
    );
    if (res.error) { dbg('photo update ERR', res.error.message||res.error); return alert(res.error.message); }
    dbg('photo update OK'); await refresh();
  }

  // CSV export/import
  on(btnExport, 'click', ()=>{
    dbg('btnExport clicked');
    const header = ['barcode','name','unit','pack_size','owner_email'];
    const lines = [header.join(',')];
    for (const r of rows) {
      const vals = [r.barcode||'', r.name||'', r.unit||'', r.pack_size||'', r.owner_email||'']
        .map(v => `"${String(v).replace(/"/g,'""')}"`);
      lines.push(vals.join(','));
    }
    const blob = new Blob([lines.join('\n')], {type:'text/csv'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'catalogue.csv'; a.click(); URL.revokeObjectURL(a.href);
  });

  on(inImport, 'change', async (e)=>{
    dbg('inImport change');
    if (!isAdmin) { alert('Only admin can import.'); return; }
    const file = e.target.files?.[0]; if(!file) return;
    const txt = await file.text();
    const lines = txt.split(/\r?\n/).filter(Boolean);
    const header = lines.shift(); if(!header) return alert('Empty CSV');
    const cols = header.split(',').map(s=>s.replace(/^"|"$/g,''));
    const idx = { barcode: cols.indexOf('barcode'), name: cols.indexOf('name'), unit: cols.indexOf('unit'), pack_size: cols.indexOf('pack_size') };
    if (idx.barcode<0) return alert('CSV must include "barcode" column');
    const user = currentUser;
    let ok=0, fail=0;
    for (const line of lines) {
      const parts = line.match(/("([^"]|"")*"|[^,]+)/g) || [];
      const unq = s => (s||'').replace(/^"|"$/g,'').replace(/""/g,'"');
      const payload = { barcode: unq(parts[idx.barcode]), user_id: user.id };
      if (idx.name>=0) payload.name = unq(parts[idx.name])||null;
      if (idx.unit>=0) payload.unit = unq(parts[idx.unit])||null;
      if (idx.pack_size>=0) payload.pack_size = unq(parts[idx.pack_size])||null;
      if (!payload.barcode) { fail++; continue; }
      const up = await withTimeout(supa.from('catalogue').upsert(payload, { onConflict:'barcode' }), 6000, 'csv.upsert');
      if (up.error) { fail++; dbg('import row ERR', up.error.message||up.error, payload.barcode); } else ok++;
    }
    alert(`Import complete: ${ok} ok, ${fail} failed`); await refresh();
  });

  // Toolbar
  on($('btnRefresh'), 'click', ()=>{ dbg('btnRefresh clicked'); refresh(); });
  on($('inSearch'), 'input', ()=>{ dbg('inSearch input'); render(); });
  on(chkAll, 'change', ()=>{ dbg('chkAll change', chkAll.checked); refresh(); });

  // Debug toolbar
  on($('btnDbgRead'), 'click', async ()=>{
    dbg('DEBUG: READ viewâ€¦');
    const v = await withTimeout(supa.from('v_catalogue_with_owner').select('*').limit(1), 5000, 'dbg.read.view');
    dbg('view:', v.error ? ('ERR '+(v.error.message||v.error)) : ('OK count='+(v.data?.length||0)));
    const t = await withTimeout(supa.from('catalogue').select('*').limit(1), 5000, 'dbg.read.table');
    dbg('table:', t.error ? ('ERR '+(t.error.message||t.error)) : ('OK count='+(t.data?.length||0)));
  });

  on($('btnDbgWrite'), 'click', async ()=>{
    dbg('DEBUG: WRITE probeâ€¦');
    const user = currentUser; if (!user) return dbg('no user');
    const b = 'DEBUG-' + Math.random().toString(36).slice(2,6);
    const ins = await withTimeout(
      supa.from('catalogue').insert({ barcode:b, name:'probe', unit:'ea', pack_size:'1', user_id:user.id }).select().single(),
      6000, 'dbg.write'
    );
    dbg(ins.error ? ('ERR '+(ins.error.message||ins.error)) : `OK id=${ins.data?.id}`);
  });

  on($('btnDbgRaw'), 'click', async ()=>{
    dbg('DEBUG: RAW probeâ€¦');
    const s = await withTimeout(supa.auth.getSession(), 3000, 'dbg.session');
    const token = s.data?.session?.access_token;
    const url = `${SUPABASE_URL}/rest/v1/catalogue?select=id,barcode,name&limit=1`;
    try{
      const res = await withTimeout(fetch(url, { headers:{ apikey: SUPABASE_ANON, Authorization: token?`Bearer ${token}`:`Bearer ${SUPABASE_ANON}` } }), 6000, 'dbg.raw.fetch');
      const text = await res.text(); dbg('raw status', res.status, 'body', text);
    }catch(e){ dbg('raw fetch ERR', e.message||String(e)); }
  });

  // Start
  boot();

})();
</script>
</body>
</html>
