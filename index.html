<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dental Inventory App</title>
  <link rel="icon" href="data:,"><!-- silence favicon 404 -->

  <!-- ================== STYLES ================== -->
  <style>
    :root {
      --bg:#f7f7fb; --card:#fff; --text:#111; --muted:#667;
      --brand:#1a73e8; --danger:#c62828; --ok:#2e7d32; --border:#e5e7eb;
      --warn:#b26a00;
    }
    * { box-sizing: border-box; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial; background:var(--bg); color:var(--text); }
    header { position:sticky; top:0; z-index:10; background:var(--card); border-bottom:1px solid var(--border); padding:12px 16px; display:flex; gap:12px; align-items:center; }
    header h1 { margin:0; font-size:18px; font-weight:600; }
    .tabs { display:flex; gap:8px; flex-wrap:wrap; }
    .tab { padding:8px 12px; border-radius:999px; border:1px solid var(--border); background:#fff; cursor:pointer; font-size:14px; white-space:nowrap; }
    .tab.active { background:var(--brand); color:#fff; border-color:var(--brand); }
    main { padding:16px; max-width:1100px; margin:0 auto; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:16px; box-shadow:0 1px 2px rgba(0,0,0,.03); margin-bottom:14px; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .row-3 { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:12px; }
    .row-4 { display:grid; grid-template-columns: repeat(4, 1fr); gap:12px; }
    .split { display:flex; gap:16px; flex-wrap:wrap; }
    .grow { flex:1 1 320px; }
    label { font-size:12px; color:var(--muted); display:block; margin-bottom:4px; }
    input, select, textarea { width:100%; padding:10px; border:1px solid var(--border); border-radius:10px; font-size:14px; background:#fff; }
    button { padding:10px 14px; border-radius:10px; border:1px solid var(--border); background:#fff; cursor:pointer; }
    button.primary { background:var(--brand); color:#fff; border-color:var(--brand); }
    button.ghost { background:#fff; }
    table { width:100%; border-collapse:collapse; }
    th, td { text-align:left; padding:10px; border-bottom:1px solid var(--border); font-size:14px; vertical-align:top; }
    th { background:#fafafa; position:sticky; top:0; z-index:1; }
    .muted { color:var(--muted); }
    .badge { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid var(--border); }
    .badge.ok { border-color:#a5d6a7; }
    .badge.warn { border-color:#ffe082; }
    .badge.danger { border-color:#ef9a9a; }
    .sticky-bottom { position:fixed; bottom:12px; left:0; right:0; display:flex; justify-content:center; pointer-events:none; }
    .sticky-bottom > * { pointer-events:auto; }
    .hidden { display:none !important; }
    .img { width:80px; height:80px; object-fit:cover; border-radius:10px; border:1px solid var(--border); background:#fafafa; }
    .bigimg { width:160px; height:160px; object-fit:cover; border-radius:10px; border:1px solid var(--border); background:#fafafa; }
    .hr { height:1px; background:var(--border); margin:12px 0; }
    dialog { border:0; border-radius:16px; padding:0; overflow:hidden; }
    dialog .dialog-body { padding:16px; }
    dialog::backdrop { background:rgba(0,0,0,0.3); }
    .ok { color:var(--ok); } .warn { color:var(--warn); } .danger { color:var(--danger); }
    .right { margin-left:auto; }

    /* ---------- Mobile layout tweaks ---------- */
    @media (max-width: 768px) {
      header { flex-wrap:wrap; align-items:flex-start; }
      header h1 { width:100%; margin-bottom:4px; }
      .tabs { width:100%; overflow-x:auto; padding-bottom:4px; }
      .row, .row-3, .row-4 { grid-template-columns: 1fr; }
      .split { flex-direction:column; }
      main { padding:10px; }
      th, td { font-size:13px; padding:8px; }
    }
  </style>

  <!-- ZXing (UMD) for iPhone-friendly scanning -->
  <script src="https://cdn.jsdelivr.net/npm/@zxing/browser@0.1.5/umd/index.min.js"></script>
  <!-- Supabase UMD (global window.supabase). Must load BEFORE our app script -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
</head>

<body>
  <!-- ================== HEADER ================== -->
  <header>
    <h1>Dental Inventory</h1>
    <div class="tabs" id="tabs"></div>
    <div class="right"><span id="whoami" class="muted"></span></div>
  </header>

  <!-- ================== MAIN ================== -->
  <main>
    <!-- ===== AUTH ===== -->
    <section id="authSection" class="card hidden">
      <h3>Sign in</h3>
      <div class="row">
        <div>
          <label>Email</label>
          <input id="email" type="email" placeholder="name@example.com" />
        </div>
        <div style="align-self:end;">
          <button id="btnMagic" class="primary">Send Magic Link</button>
        </div>
      </div>
      <div class="hr"></div>
      <button id="btnGoogle">Continue with Google</button>
      <p class="muted">We use your email to link your clinic data.</p>
    </section>

    <!-- ===== APP SHELL (only visible after login) ===== -->
    <div id="appShell" class="hidden">
      <!-- ===== TRANSACTIONS (default) ===== -->
      <section id="tab-transactions" class="card hidden">
        <h3>Transactions</h3>
        <div class="split">
          <div class="grow">
            <div class="row">
              <div>
                <label>Scan / Enter Barcode</label>
                <div class="row">
                  <input id="trxBarcode" placeholder="Scan or type barcode…" inputmode="numeric" />
                  <button id="btnScan" class="ghost">Scan</button>
                </div>
                <p class="muted">iPhone scanning supported via camera plugin (ZXing).</p>
              </div>
              <div>
                <label>Kind</label>
                <select id="trxKind">
                  <option value="IN">IN</option>
                  <option value="OUT">OUT</option>
                  <option value="ADJUST">ADJUST</option>
                </select>
              </div>
            </div>
            <div class="row">
              <div>
                <label>Quantity</label>
                <input id="trxQty" type="number" step="0.001" placeholder="e.g. 1, 2.5"/>
              </div>
              <div>
                <label>Unit Cost (optional)</label>
                <input id="trxCost" type="number" step="0.01" placeholder="e.g. 12.90"/>
              </div>
            </div>
            <div class="row">
              <div>
                <label>Lot Code (optional)</label>
                <input id="trxLot" placeholder="LOT/Batch"/>
              </div>
              <div>
                <label>Expiry Date (optional)</label>
                <input id="trxExpiry" placeholder="dd/mm/yyyy" />
              </div>
            </div>
            <div>
              <label>Note</label>
              <input id="trxNote" placeholder="Free text note"/>
            </div>
            <div style="margin-top:12px;">
              <button id="btnSaveTrx" class="primary">Save Transaction</button>
            </div>
            <div class="hr"></div>
            <h4>Recent Transactions</h4>
            <div id="trxTableWrap" style="max-height:360px; overflow:auto;">
              <table id="trxTable">
                <thead><tr>
                  <th>When</th><th>Barcode</th><th>Name</th><th>Kind</th><th>Qty</th><th>Lot</th><th>Expiry</th><th>Note</th>
                </tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <div class="grow">
            <div class="card">
              <h4>Item Preview</h4>
              <div class="row">
                <img id="prevImg" class="img" alt="">
                <div>
                  <div><strong id="prevName">—</strong></div>
                  <div class="muted" id="prevBarcode">—</div>
                  <div id="prevStock" class="badge">Stock: —</div>
                </div>
              </div>
              <div class="hr"></div>
              <div class="row">
                <div>
                  <label>Item Name</label>
                  <input id="prevNameEdit" placeholder="Required for new items"/>
                </div>
                <div>
                  <label>Photo</label>
                  <input id="prevPhoto" type="file" accept="image/*" />
                  <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
                    <button id="btnAIFromPhoto" class="ghost">AI fill from photo</button>
                    <button id="btnCapturePhoto" class="ghost">Capture with camera</button>
                  </div>
                </div>
              </div>
              <div class="row">
                <div>
                  <label>Unit</label>
                  <input id="prevUnit" placeholder="box, pkt, ea…"/>
                </div>
                <div>
                  <label>Pack Size</label>
                  <input id="prevPack" placeholder="e.g. 100s"/>
                </div>
              </div>
              <div class="row">
                <div>
                  <label>Minimum Qty (reorder)</label>
                  <input id="prevMinQty" type="number" step="0.001" placeholder="e.g. 2"/>
                </div>
              </div>
              <button id="btnSaveItem" class="ghost">Save / Update Item</button>
            </div>
          </div>
        </div>
      </section>

      <!-- ===== CATALOGUE ===== -->
      <section id="tab-catalogue" class="card hidden">
        <div class="split">
          <h3>Catalogue</h3>
          <div class="row" style="width:420px;">
            <input id="catSearch" placeholder="Search name or barcode…" />
            <button id="btnAddNew" class="ghost">New</button>
          </div>
        </div>
        <div class="hr"></div>
        <div id="catTableWrap" style="max-height:520px; overflow:auto;">
          <table id="catTable">
            <thead><tr>
              <th>Photo</th><th>Barcode</th><th>Name</th><th>Unit</th><th>Pack</th><th>Min Qty</th><th>Stock</th>
            </tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <!-- ===== RE-ORDERING ===== -->
      <section id="tab-reorder" class="card hidden">
        <div class="split">
          <h3>Re-ordering</h3>
          <div class="row" style="width:420px;">
            <label for="selReorderSort" class="muted" style="align-self:center;">Sort by</label>
            <select id="selReorderSort">
              <option value="expiry">Expiry (soonest first)</option>
              <option value="minqty">Minimum Quantity (most urgent first)</option>
            </select>
          </div>
        </div>
        <p class="muted">Shows items below Minimum Qty and/or expiring within ~1 month.</p>
        <div class="hr"></div>
        <div id="reTableWrap" style="max-height:520px; overflow:auto;">
          <table id="reTable">
            <thead><tr>
              <th>Barcode</th><th>Name</th><th>Stock</th><th>Min Qty</th><th>Nearest Expiry</th><th>Status</th>
            </tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <!-- ===== REPORTS ===== -->
      <section id="tab-reports" class="card hidden">
        <h3>Reports</h3>
        <div id="repSummary" class="row-3"></div>
      </section>

      <!-- ===== AI TEST (Sandbox) ===== -->
      <section id="tab-lab" class="card hidden">
        <h3>AI Product Extract (Sandbox)</h3>
        <p class="muted">Upload or capture a packaging photo. We’ll OCR and suggest name/unit/pack size (and barcode if visible). This tab does not auto-save.</p>

        <div class="row" style="margin-top:8px;">
          <div>
            <label>Packaging Photo</label>
            <input id="labPhoto" type="file" accept="image/*" />
            <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
              <button id="labCapture" class="ghost">Capture with camera</button>
              <button id="labRun" class="primary">Run AI on photo</button>
            </div>
            <div style="margin-top:12px;">
              <img id="labPreview" class="bigimg" alt="">
            </div>
          </div>
          <div>
            <label>Result</label>
            <div id="labResultBox" class="card" style="min-height:140px;">
              <div id="labStatus" class="muted">No result yet.</div>
              <div id="labResult" class="hidden">
                <div><strong>Name:</strong> <span id="labName">—</span></div>
                <div><strong>Unit:</strong> <span id="labUnit">—</span></div>
                <div><strong>Pack size:</strong> <span id="labPack">—</span></div>
                <div><strong>Barcode:</strong> <span id="labBarcode">—</span></div>
                <div><strong>Confidence:</strong> <span id="labConf">—</span></div>
                <div class="hr"></div>
                <button id="labApply" class="ghost">Apply to Item Preview</button>
                <button id="labCreateDraft" class="ghost">Create Draft Item</button>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- ===== DEBUG ===== -->
      <section id="debugSection" class="card hidden">
        <h3>Debug Console</h3>
        <pre id="debugOut" style="white-space:pre-wrap;"></pre>
        <div class="row">
          <button id="btnResetSession" class="ghost">Reset Session</button>
          <button id="btnWhoami" class="ghost">Who am I?</button>
        </div>
      </section>
    </div> <!-- /appShell -->
  </main>

  <!-- Scanner Modal -->
  <dialog id="scanModal">
    <div class="dialog-body">
      <div class="split">
        <h3>Scan Barcode</h3>
        <button id="btnCloseScan" class="ghost" style="margin-left:auto;">Close</button>
      </div>
      <video id="video" playsinline style="width:100%; border-radius:12px; border:1px solid var(--border); background:#000; aspect-ratio: 3/4;"></video>
      <p class="muted">Use rear camera when available.</p>
    </div>
  </dialog>

  <!-- Sticky “Show Debug” button at the bottom -->
  <div class="sticky-bottom">
    <button id="btnToggleDebug" class="tab">Show Debug</button>
  </div>

  <!-- ================== APP SCRIPT ================== -->
  <script type="module">
    // ---------- CONFIG ----------
    const SUPABASE_URL  = 'https://sgjoadsefpcixvmthtfy.supabase.co';
    const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNnam9hZHNlZnBjaXh2bXRodGZ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwMDIyMjYsImV4cCI6MjA3NDU3ODIyNn0.UcmAuHzEtKZIBs0pGkcLyRIYcLzCA4tNfuuDkUVLpU8';
    const REDIRECT_URL  = location.origin + location.pathname;

    if (!window.supabase || !window.supabase.createClient) {
      alert('Supabase library failed to load. Check the <script> tag order.');
      throw new Error('Supabase UMD not available');
    }
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

    // ---------- UTIL ----------
    const $  = (q) => document.querySelector(q);
    const $$ = (q) => Array.from(document.querySelectorAll(q));
    const fmtDate = (d) => d ? new Date(d).toLocaleDateString() : '—';
    const toISOFromDDMMYYYY = (s) => {
      if (!s) return null;
      const m = /^(\d{1,2})\/(\d{1,2})\/(\d{4})$/.exec(s.trim());
      if (!m) return null;
      const [_, dd, mm, yyyy] = m.map(Number);
      const iso = new Date(yyyy, mm - 1, dd);
      return isNaN(iso) ? null : iso.toISOString().slice(0,10);
    };
    function logDebug(obj) {
      const el = $('#debugOut');
      el.textContent = JSON.stringify(obj, null, 2) + '\n\n' + el.textContent;
    }

    // ---------- TABS ----------
    const tabs = [
      { id:'transactions', label:'Transactions' },
      { id:'catalogue',    label:'Catalogue' },
      { id:'reorder',      label:'Re-ordering' },
      { id:'reports',      label:'Reports' },
      { id:'lab',          label:'AI Test' },
    ];
    let activeTab = 'transactions';

    function renderTabs() {
      const el = $('#tabs'); el.innerHTML = '';
      for (const t of tabs) {
        const b = document.createElement('button');
        b.className = 'tab' + (t.id===activeTab ? ' active':'');
        b.textContent = t.label;
        b.addEventListener('click', () => { activeTab = t.id; updateTabUI(); });
        el.appendChild(b);
      }
      updateTabUI();
    }
    function updateTabUI() {
      for (const t of tabs) $('#tab-'+t.id)?.classList.toggle('hidden', t.id!==activeTab);
      $$('#tabs .tab').forEach(btn =>
        btn.classList.toggle('active', btn.textContent === tabs.find(x=>x.id===activeTab)?.label)
      );
    }

    // ---------- DEBUG ----------
    $('#btnToggleDebug').addEventListener('click', () => {
      const hidden = $('#debugSection').classList.toggle('hidden');
      $('#btnToggleDebug').textContent = hidden ? 'Show Debug' : 'Hide Debug';
    });
    $('#btnResetSession').addEventListener('click', async () => {
      await supabase.auth.signOut(); location.reload();
    });
    $('#btnWhoami').addEventListener('click', async () => {
      const u = await supabase.auth.getUser(); logDebug(u);
    });

    // ---------- AUTH ----------
    async function ensureProfile(user) {
      await supabase.from('profiles').upsert({ id: user.id, email: user.email }, { onConflict: 'id' });
    }

    async function showAppOrAuth() {
      const { data:{ user } } = await supabase.auth.getUser();

      if (!user) {
        // show login, hide app
        $('#authSection').classList.remove('hidden');
        $('#whoami').textContent = '';
        $('#appShell').classList.add('hidden');
        $('#tabs').innerHTML = '';
        tabs.forEach(t => $('#tab-'+t.id)?.classList.add('hidden'));
      } else {
        $('#authSection').classList.add('hidden');
        $('#whoami').textContent = user.email ?? '';
        $('#appShell').classList.remove('hidden');

        if (!$('#tabs').children.length) {
          activeTab = 'transactions';
          renderTabs();
        }
        await ensureProfile(user);
        await refreshAll();
      }
    }

    $('#btnGoogle').addEventListener('click', async () => {
      await supabase.auth.signInWithOAuth({ provider:'google', options:{ redirectTo: REDIRECT_URL } });
    });
    $('#btnMagic').addEventListener('click', async () => {
      const email = $('#email').value.trim();
      if (!email) return alert('Enter your email first');
      const { error } = await supabase.auth.signInWithOtp({ email, options:{ emailRedirectTo: REDIRECT_URL } });
      if (error) alert(error.message); else alert('Magic link sent!');
    });

    // ---------- ZXing Scanner ----------
    let codeReader;
    const scanModal = $('#scanModal');
    const videoEl   = $('#video');
    async function startScan() {
      if (!codeReader) codeReader = new ZXingBrowser.BrowserMultiFormatReader();
      try {
        const devices = await ZXingBrowser.BrowserCodeReader.listVideoInputDevices();
        const back = devices.find(d => /back|rear|environment/i.test(d.label))?.deviceId ?? devices?.[0]?.deviceId;
        await codeReader.decodeFromVideoDevice(back, videoEl, (result) => {
          if (result) {
            $('#trxBarcode').value = result.getText();
            stopScan(); scanModal.close(); handleBarcodeEntered();
          }
        });
      } catch (e) { alert('Camera error: ' + e.message); }
    }
    function stopScan() { try { codeReader?.reset(); } catch {} }
    $('#btnScan').addEventListener('click', () => { scanModal.showModal(); startScan(); });
    $('#btnCloseScan').addEventListener('click', () => { stopScan(); scanModal.close(); });

    // ---------- STORAGE (photos) ----------
    async function uploadPhoto(file, barcode) {
      if (!file) return null;
      const ext = file.name.split('.').pop() || 'jpg';
      const path = `${barcode}/${Date.now()}.${ext}`;
      const { data, error } = await supabase.storage.from('product_photos').upload(path, file, { upsert: true });
      if (error) throw error;
      const { data: pub } = supabase.storage.from('product_photos').getPublicUrl(path);
      return pub.publicUrl;
    }

    // ---------- DATA CACHE ----------
    let cacheItems = [];
    let cacheLots  = [];

    async function fetchStockPerItem() {
      const { data, error } = await supabase.from('v_stock_per_item').select('*').order('name', { ascending: true });
      if (error) throw error;
      return data;
    }
    async function fetchLots() {
      const { data, error } = await supabase.from('v_stock_per_lot').select('*');
      if (error) throw error;
      return data;
    }
    function nearestExpiryForItem(itemId) {
      const lots = cacheLots.filter(l => l.item_id === itemId && l.expiry_date);
      if (!lots.length) return null;
      return lots.sort((a,b) => new Date(a.expiry_date) - new Date(b.expiry_date))[0].expiry_date;
    }

    // ---------- TRANSACTIONS ----------
    function fillPreview(item) {
      $('#prevImg').src = item.photo_url || '';
      $('#prevName').textContent = item.name || '(New item)';
      $('#prevBarcode').textContent = item.barcode || '—';
      $('#prevStock').textContent = `Stock: ${Number(item.stock_qty ?? 0)}`;
      $('#prevNameEdit').value = item.name ?? '';
      $('#prevUnit').value = item.unit ?? '';
      $('#prevPack').value = item.pack_size ?? '';
      $('#prevMinQty').value = item.min_qty ?? 0;
      $('#prevPhoto').value = '';
      $('#prevNameEdit').dataset.itemId = item.id || '';
    }

    async function handleBarcodeEntered() {
      const code = $('#trxBarcode').value.trim();
      if (!code) return;
      const item = cacheItems.find(x => x.barcode === code);
      if (item) fillPreview(item);
      else fillPreview({ id:null, barcode:code, name:'', unit:'', pack_size:'', min_qty:0, photo_url:null, stock_qty:0 });
    }
    $('#trxBarcode').addEventListener('change', handleBarcodeEntered);

    $('#btnCapturePhoto').addEventListener('click', () => {
      const input = $('#prevPhoto');
      input.setAttribute('capture', 'environment');
      input.click();
    });

    // AI fill from photo (uses Edge Function)
    async function aiSuggestFromPhoto() {
      const file = $('#prevPhoto').files[0];
      if (!file) { alert('Choose or capture a packaging photo first.'); return; }

      const barcode = $('#trxBarcode').value.trim() || `temp-${Date.now()}`;
      const ext = file.name.split('.').pop() || 'jpg';
      const path = `${barcode}/ai-src-${Date.now()}.${ext}`;
      const { error: upErr } = await supabase.storage.from('product_photos').upload(path, file, { upsert: true });
      if (upErr) { alert('Upload failed: ' + upErr.message); return; }
      const { data: pub } = supabase.storage.from('product_photos').getPublicUrl(path);
      const image_url = pub.publicUrl;

      let data, error;
      try {
        const resp = await supabase.functions.invoke('ai_guess_product', { body: { image_url } });
        data = resp.data; error = resp.error;
      } catch (e) {
        logDebug({ edge_error: String(e) });
        alert('AI error: could not reach edge function (check it is deployed and VISION_API_KEY is set).');
        return;
      }
      if (error) {
        logDebug({ edge_error: error });
        alert('AI error: ' + (error.message || JSON.stringify(error)));
        return;
      }

      if (data?.name && !$('#prevNameEdit').value) { $('#prevNameEdit').value = data.name; $('#prevName').textContent = data.name; }
      if (data?.unit && !$('#prevUnit').value) $('#prevUnit').value = data.unit;
      if (data?.pack_size && !$('#prevPack').value) $('#prevPack').value = data.pack_size;
      if (data?.barcode && !$('#trxBarcode').value) { $('#trxBarcode').value = data.barcode; $('#prevBarcode').textContent = data.barcode; }

      try {
        await supabase.from('product_ai_suggestions').insert({
          image_url,
          suggested_name: data?.name ?? null,
          suggested_unit: data?.unit ?? null,
          suggested_pack_size: data?.pack_size ?? null,
          suggested_barcode: data?.barcode ?? null,
          confidence: data?.confidence ?? null,
          notes: data?.notes ?? null
        });
      } catch {}
      alert(data?.name ? `Suggested: ${data.name}` : 'No confident suggestion. Try a clearer photo.');
    }
    $('#btnAIFromPhoto').addEventListener('click', aiSuggestFromPhoto);

    $('#btnSaveItem').addEventListener('click', async () => {
      const barcode = $('#trxBarcode').value.trim() || prompt('Enter barcode for this item');
      if (!barcode) return;
      const name = $('#prevNameEdit').value.trim();
      if (!name) return alert('Item name is required.');
      const unit = $('#prevUnit').value.trim();
      const pack = $('#prevPack').value.trim();
      const minq = Number($('#prevMinQty').value || 0);
      const photoFile = $('#prevPhoto').files[0];
      let photoUrl = null;
      if (photoFile) {
        try { photoUrl = await uploadPhoto(photoFile, barcode); }
        catch (e) { return alert('Photo upload failed: ' + e.message); }
      }
      const payload = { barcode, name, unit, pack_size: pack, min_qty: minq };
      if (photoUrl) payload.photo_url = photoUrl;

      const existing = cacheItems.find(x => x.barcode === barcode);
      let q;
      if (existing) q = supabase.from('catalogue').update(payload).eq('id', existing.id).select();
      else          q = supabase.from('catalogue').insert(payload).select();
      const { data, error } = await q;
      if (error) return alert(error.message);
      await refreshAll();
      alert('Item saved.');
    });

    $('#btnSaveTrx').addEventListener('click', async () => {
      const barcode = $('#trxBarcode').value.trim();
      if (!barcode) return alert('Enter or scan a barcode');
      const kind = $('#trxKind').value;
      const qty  = Number($('#trxQty').value || 0);
      if (!qty) return alert('Enter a quantity');

      let item = cacheItems.find(x => x.barcode === barcode);
      if (!item) {
        const name = $('#prevNameEdit').value.trim();
        if (!name) return alert('New barcode: please enter Item Name and Save Item first.');
        const unit = $('#prevUnit').value.trim();
        const pack = $('#prevPack').value.trim();
        const minq = Number($('#prevMinQty').value || 0);
        const { data, error } = await supabase.from('catalogue').insert({ barcode, name, unit, pack_size: pack, min_qty: minq }).select();
        if (error) return alert(error.message);
        item = data[0];
      }

      const row = {
        item_id: item.id,
        kind,
        qty,
        lot_code: $('#trxLot').value.trim() || null,
        expiry_date: toISOFromDDMMYYYY($('#trxExpiry').value),
        unit_cost: $('#trxCost').value ? Number($('#trxCost').value) : null,
        note: $('#trxNote').value.trim() || null
      };
      const { error } = await supabase.from('inv_transactions').insert(row);
      if (error) return alert(error.message);

      $('#trxQty').value = ''; $('#trxLot').value = ''; $('#trxExpiry').value = '';
      $('#trxCost').value = ''; $('#trxNote').value = '';
      await refreshAll();
    });

    async function loadRecentTrx() {
      const { data, error } = await supabase
        .from('v_inv_transactions_signed')
        .select('created_at, kind, qty, lot_code, expiry_date, note, item_id')
        .order('created_at', { ascending:false })
        .limit(50);
      if (error) throw error;

      const map = new Map(cacheItems.map(x => [x.id, x]));
      const tb = $('#trxTable tbody'); tb.innerHTML = '';
      for (const r of data) {
        const it = map.get(r.item_id);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${new Date(r.created_at).toLocaleString()}</td>
          <td>${it?.barcode ?? '—'}</td>
          <td>${it?.name ?? '—'}</td>
          <td>${r.kind}</td>
          <td>${r.qty}</td>
          <td>${r.lot_code ?? ''}</td>
          <td>${fmtDate(r.expiry_date)}</td>
          <td>${r.note ?? ''}</td>`;
        tb.appendChild(tr);
      }
    }

    // ---------- CATALOGUE ----------
    function renderCatalogue() {
      const q = $('#catSearch').value.trim().toLowerCase();
      const rows = !q ? cacheItems : cacheItems.filter(
        x => (x.name||'').toLowerCase().includes(q) || (x.barcode||'').toLowerCase().includes(q)
      );
      const tb = $('#catTable tbody'); tb.innerHTML = '';
      for (const r of rows) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.photo_url ? `<img src="${r.photo_url}" class="img" />` : ''}</td>
          <td>${r.barcode}</td>
          <td>${r.name ?? ''}</td>
          <td>${r.unit ?? ''}</td>
          <td>${r.pack_size ?? ''}</td>
          <td>${Number(r.min_qty ?? 0)}</td>
          <td>${Number(r.stock_qty ?? 0)}</td>
        `;
        tr.style.cursor = 'pointer';
        tr.addEventListener('click', () => {
          activeTab = 'transactions'; updateTabUI();
          $('#trxBarcode').value = r.barcode; fillPreview(r); $('#trxQty').focus();
        });
        tb.appendChild(tr);
      }
    }
    $('#catSearch').addEventListener('input', renderCatalogue);
    $('#btnAddNew').addEventListener('click', () => {
      activeTab = 'transactions'; updateTabUI();
      $('#trxBarcode').value = '';
      fillPreview({ id:null, barcode:'', name:'', unit:'', pack_size:'', min_qty:0, photo_url:null, stock_qty:0 });
      $('#trxBarcode').focus();
    });

    // ---------- RE-ORDER ----------
    function renderReorder() {
      const items = cacheItems.map(it => ({ ...it, nearestExpiry: nearestExpiryForItem(it.id) }));
      const soon = new Date(); soon.setMonth(soon.getMonth() + 1);
      const candidates = items.filter(it => {
        const belowMin = Number(it.stock_qty ?? 0) < Number(it.min_qty ?? 0);
        const expSoon  = it.nearestExpiry && new Date(it.nearestExpiry) <= soon;
        return belowMin || expSoon;
      });

      const mode = $('#selReorderSort').value;
      if (mode === 'expiry') {
        candidates.sort((a,b) => {
          const ae = a.nearestExpiry ? new Date(a.nearestExpiry).getTime() : Infinity;
          const be = b.nearestExpiry ? new Date(b.nearestExpiry).getTime() : Infinity;
          return ae - be;
        });
      } else {
        candidates.sort((a,b) => {
          const da = Number(a.min_qty||0) - Number(a.stock_qty||0);
          const db = Number(b.min_qty||0) - Number(b.stock_qty||0);
          return db - da;
        });
      }

      const tb = $('#reTable tbody'); tb.innerHTML = '';
      for (const r of candidates) {
        const below = Number(r.stock_qty ?? 0) < Number(r.min_qty ?? 0);
        const soonFlag = r.nearestExpiry && new Date(r.nearestExpiry) <= soon;
        const status = below && soonFlag ? 'Below min & Expiring soon'
                     : below ? 'Below min'
                     : 'Expiring soon';
        const cls = below ? 'danger' : 'warn';
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.barcode}</td>
          <td>${r.name ?? ''}</td>
          <td>${Number(r.stock_qty ?? 0)}</td>
          <td>${Number(r.min_qty ?? 0)}</td>
          <td>${fmtDate(r.nearestExpiry)}</td>
          <td class="${cls}">${status}</td>
        `;
        tb.appendChild(tr);
      }
    }
    $('#selReorderSort').addEventListener('change', renderReorder);

    // ---------- REPORTS ----------
    function renderReports() {
      const totalSkus = cacheItems.length;
      const totalOnHand = cacheItems.reduce((s,x) => s + Number(x.stock_qty||0), 0);
      const belowMin = cacheItems.filter(x => Number(x.stock_qty||0) < Number(x.min_qty||0)).length;

      $('#repSummary').innerHTML = `
        <div class="card"><div class="muted">SKUs</div><div style="font-size:24px; font-weight:700;">${totalSkus}</div></div>
        <div class="card"><div class="muted">Total On Hand</div><div style="font-size:24px; font-weight:700;">${totalOnHand}</div></div>
        <div class="card"><div class="muted">Below Min</div><div style="font-size:24px; font-weight:700;">${belowMin}</div></div>
      `;
    }

    // ---------- AI TEST (sandbox) ----------
    const labPhoto     = $('#labPhoto');
    const labCapture   = $('#labCapture');
    const labRun       = $('#labRun');
    const labPreview   = $('#labPreview');
    const labStatus    = $('#labStatus');
    const labResult    = $('#labResult');
    const labName      = $('#labName');
    const labUnit      = $('#labUnit');
    const labPack      = $('#labPack');
    const labBarcode   = $('#labBarcode');
    const labConf      = $('#labConf');

    labCapture?.addEventListener('click', () => {
      labPhoto.setAttribute('capture', 'environment');
      labPhoto.click();
    });
    labPhoto?.addEventListener('change', () => {
      const f = labPhoto.files?.[0];
      if (!f) return;
      labPreview.src = URL.createObjectURL(f);
    });
    labRun?.addEventListener('click', async () => {
      const f = labPhoto.files?.[0];
      if (!f) { alert('Choose or capture a packaging photo first.'); return; }
      labStatus.textContent = 'Uploading photo…'; labResult.classList.add('hidden');

      const ext = f.name.split('.').pop() || 'jpg';
      const path = `ai-tests/${Date.now()}.${ext}`;
      const { error: upErr } = await supabase.storage.from('product_photos').upload(path, f, { upsert: true });
      if (upErr) { labStatus.textContent = 'Upload failed: ' + upErr.message; return; }
      const { data: pub } = supabase.storage.from('product_photos').getPublicUrl(path);
      const image_url = pub.publicUrl;

      labStatus.textContent = 'Running AI extraction…';

      let data, error;
      try {
        const resp = await supabase.functions.invoke('ai_guess_product', { body: { image_url } });
        data = resp.data; error = resp.error;
      } catch (e) {
        logDebug({ edge_error: String(e) });
        labStatus.textContent = 'AI error: could not reach edge function (check deploy + VISION_API_KEY).';
        return;
      }
      if (error) {
        logDebug({ edge_error: error });
        labStatus.textContent = 'AI error: ' + (error.message || JSON.stringify(error));
        return;
      }

      labStatus.textContent = 'Suggestion ready.'; labResult.classList.remove('hidden');
      labName.textContent    = data?.name || '—';
      labUnit.textContent    = data?.unit || '—';
      labPack.textContent    = data?.pack_size || '—';
      labBarcode.textContent = data?.barcode || '—';
      labConf.textContent    = (data?.confidence != null) ? String(data.confidence) : '—';

      try {
        await supabase.from('product_ai_suggestions').insert({
          image_url,
          suggested_name: data?.name ?? null,
          suggested_unit: data?.unit ?? null,
          suggested_pack_size: data?.pack_size ?? null,
          suggested_barcode: data?.barcode ?? null,
          confidence: data?.confidence ?? null,
          notes: data?.notes ?? null
        });
      } catch {}
    });

    $('#labApply')?.addEventListener('click', () => {
      if (labName.textContent !== '—' && !$('#prevNameEdit').value) {
        $('#prevNameEdit').value = labName.textContent;
        $('#prevName').textContent = labName.textContent;
      }
      if (labUnit.textContent !== '—' && !$('#prevUnit').value) $('#prevUnit').value = labUnit.textContent;
      if (labPack.textContent !== '—' && !$('#prevPack').value) $('#prevPack').value = labPack.textContent;
      if (labBarcode.textContent !== '—' && !$('#trxBarcode').value) {
        $('#trxBarcode').value = labBarcode.textContent;
        $('#prevBarcode').textContent = labBarcode.textContent;
      }
      alert('Applied to Item Preview (not saved yet).');
    });

    $('#labCreateDraft')?.addEventListener('click', async () => {
      const name = (labName.textContent !== '—') ? labName.textContent : null;
      if (!name) return alert('No product name to create a draft.');
      const payload = {
        name,
        unit: (labUnit.textContent !== '—') ? labUnit.textContent : null,
        pack_size: (labPack.textContent !== '—') ? labPack.textContent : null,
        barcode: (labBarcode.textContent !== '—') ? labBarcode.textContent : null,
        min_qty: 0
      };
      const { error } = await supabase.from('catalogue').insert(payload);
      if (error) return alert('Create draft failed: ' + error.message);
      await refreshAll();
      alert('Draft item created.');
    });

    // ---------- REFRESH ----------
    async function refreshAll() {
      const [items, lots] = await Promise.all([fetchStockPerItem(), fetchLots()]);
      cacheItems = items; cacheLots = lots;

      if ($('#trxBarcode').value) {
        const found = cacheItems.find(x => x.barcode === $('#trxBarcode').value.trim());
        fillPreview(found || { id:null, barcode:$('#trxBarcode').value.trim(), name:'', unit:'', pack_size:'', min_qty:0, photo_url:null, stock_qty:0 });
      }
      renderCatalogue(); renderReorder(); renderReports(); await loadRecentTrx();
    }

    // ---------- STARTUP ----------
    window.addEventListener('load', showAppOrAuth);
    supabase.auth.onAuthStateChange(() => showAppOrAuth());
  </script>
</body>
</html>
