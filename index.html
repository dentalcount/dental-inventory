<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Dental Inventory</title>
  <style>
    :root{--bg:#0f172a;--card:#111827;--muted:#94a3b8;--text:#e5e7eb;--accent:#22d3ee;--danger:#ef4444;--ok:#22c55e}
    html,body{margin:0;height:100%;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#0b1220;color:var(--text)}
    .wrap{max-width:1100px;margin:0 auto;padding:20px}
    .card{background:linear-gradient(180deg,#0b1220,#0b1220) padding-box,linear-gradient(145deg,rgba(255,255,255,.12),rgba(255,255,255,0)) border-box;border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:16px;margin:14px 0}
    h1{font-weight:700;letter-spacing:.3px}
    label{display:block;margin:.5rem 0 .25rem;color:var(--muted);font-size:.9rem}
    input,select,button,textarea{width:100%;padding:.7rem .8rem;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#0d1526;color:var(--text);outline:none}
    input:focus,select:focus,textarea:focus{border-color:var(--accent)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .btn{cursor:pointer;border:none}
    .btn.primary{background:linear-gradient(90deg,#00c2ff,#14f1d9);color:#002b36;font-weight:700}
    .btn.reset{background:#1f2937}
    .btn.danger{background:#2a0f12;border:1px solid rgba(239,68,68,.4);color:#fecaca}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:.25rem .6rem;border-radius:999px;background:#102037;border:1px solid rgba(255,255,255,.08);color:#a5b4fc}
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    th,td{padding:.65rem .6rem;text-align:left}
    thead th{font-size:.85rem;color:var(--muted);font-weight:600}
    tbody tr{background:#0c1426;border:1px solid rgba(255,255,255,.06)}
    tbody tr td:first-child{border-top-left-radius:10px;border-bottom-left-radius:10px}
    tbody tr td:last-child{border-top-right-radius:10px;border-bottom-right-radius:10px}
    .flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .right{margin-left:auto}
    .hint{color:var(--muted);font-size:.85rem}
    .hidden{display:none !important}
    .badge{padding:.2rem .5rem;border-radius:999px;border:1px solid rgba(255,255,255,.08);font-size:.75rem}
    .owner{color:#93c5fd}
    .srch{display:flex;gap:10px;align-items:center}
    .file{padding:.5rem;background:#0d1628;border-radius:10px;border:1px dashed rgba(255,255,255,.12)}
    .preview{max-height:64px;border-radius:8px;border:1px solid rgba(255,255,255,.1)}
    .tight{max-width:680px}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
  </style>
  <script defer src="https://unpkg.com/@supabase/supabase-js@2.44.4/dist/umd/supabase.js"></script>
</head>
<body>
<div class="wrap">
  <h1>Dental Inventory <span id="roleBadge" class="pill hidden"></span></h1>

  <!-- Auth -->
  <div id="authCard" class="card">
    <div class="row">
      <div>
        <label>Email for magic link</label>
        <input id="email" type="email" placeholder="you@clinic.com"/>
      </div>
      <div style="align-self:end">
        <button id="btnMagic" class="btn primary">Send Sign-In Link</button>
      </div>
    </div>
    <div class="flex" style="margin-top:8px">
      <button id="btnReset" class="btn reset">Reset Session</button>
      <span class="hint">We use passwordless sign-in. Check your email and open the link on this device.</span>
    </div>
  </div>

  <!-- App -->
  <div id="app" class="hidden">
    <!-- New item / scan -->
    <div class="card">
      <div class="flex">
        <div class="pill">Add / Scan Item</div>
        <span class="right hint">New items require a <strong>Name</strong> before they’re saved.</span>
      </div>
      <div class="row3" style="margin-top:12px">
        <div>
          <label>Barcode</label>
          <input id="inBarcode" class="mono" placeholder="Scan or type…"/>
        </div>
        <div>
          <label>Item Name <span class="hint">(required for new items)</span></label>
          <input id="inName" placeholder="e.g., GIC Fuji IX Capsule A2"/>
        </div>
        <div>
          <label>Unit</label>
          <input id="inUnit" placeholder="box / pack / ea"/>
        </div>
      </div>
      <div class="row3">
        <div>
          <label>Pack Size</label>
          <input id="inPack" placeholder="e.g., x10 / 50pcs / 3g"/>
        </div>
        <div>
          <label>Photo (capture or choose)</label>
          <input id="inPhoto" type="file" accept="image/*" capture="environment"/>
        </div>
        <div style="align-self:end">
          <button id="btnAdd" class="btn primary">Save / Upsert</button>
        </div>
      </div>
      <div id="photoPreviewWrap" class="flex hidden" style="margin-top:8px">
        <img id="photoPreview" class="preview" alt="preview"/>
        <span class="hint">This photo will be uploaded when you save.</span>
      </div>
      <div class="hint tight" style="margin-top:8px">
        Tip: If the barcode already exists in your org, this will update Unit/Pack/Photo (Name stays unless you provided a new one).
      </div>
    </div>

    <!-- Catalogue -->
    <div class="card">
      <div class="flex">
        <div class="pill">Catalogue</div>
        <div class="srch right">
          <input id="inSearch" placeholder="Search name or barcode…" class="mono"/>
          <button id="btnRefresh" class="btn">Refresh</button>
          <button id="btnExport" class="btn" title="CSV export (admin only)">Export CSV</button>
          <label class="file hidden" id="lblImport">
            <input id="inImport" type="file" accept=".csv" class="hidden"/>
            <span>Import CSV (admin)</span>
          </label>
        </div>
      </div>
      <div class="hint" style="margin:6px 0 10px">
        Admins can toggle <label style="display:inline;margin:0 6px"><input id="chkAll" type="checkbox"/> View all users</label>
        <span id="orgHint" class="badge"></span>
      </div>
      <div style="overflow:auto">
        <table>
          <thead>
          <tr>
            <th>Photo</th>
            <th>Barcode</th>
            <th>Name</th>
            <th>Unit</th>
            <th>Pack</th>
            <th class="owner">Owner</th>
            <th>Actions</th>
          </tr>
          </thead>
          <tbody id="tblBody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
(async () => {
  // -------- Supabase init --------
  const SUPABASE_URL = 'https://sgjoadsefpcixvmthtfy.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNnam9hZHNlZnBjaXh2bXRodGZ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwMDIyMjYsImV4cCI6MjA3NDU3ODIyNn0.UcmAuHzEtKZIBs0pGkcLyRIYcLzCA4tNfuuDkUVLpU8';
  const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth: {
      persistSession: true,
      detectSessionInUrl: true,
      flowType: 'pkce'
    }
  });

  // Elements
  const el = id => document.getElementById(id);
  const authCard = el('authCard');
  const app = el('app');
  const roleBadge = el('roleBadge');
  const orgHint = el('orgHint');

  const inBarcode = el('inBarcode');
  const inName = el('inName');
  const inUnit = el('inUnit');
  const inPack = el('inPack');
  const inPhoto = el('inPhoto');
  const photoPreviewWrap = el('photoPreviewWrap');
  const photoPreview = el('photoPreview');
  const inSearch = el('inSearch');
  const tblBody = el('tblBody');
  const chkAll = el('chkAll');
  const btnExport = el('btnExport');
  const inImport = el('inImport');
  const lblImport = el('lblImport');

  let profile = null;     // { id, email, role, org_id }
  let isAdmin = false;
  let viewAll = false;
  let currentOrg = null;
  let rows = [];

  // --- Auth UI ---
  el('btnMagic').onclick = async () => {
    const email = el('email').value.trim();
    if (!email) return alert('Enter your email');
    const { error } = await supa.auth.signInWithOtp({ email, options: { emailRedirectTo: window.location.href }});
    if (error) return alert(error.message);
    alert('Check your email for the sign-in link.');
  };
  el('btnReset').onclick = async () => {
    await supa.auth.signOut(); // keep only reset, signout removed elsewhere
    localStorage.clear();
    sessionStorage.clear();
    location.reload();
  };

  inPhoto.addEventListener('change', () => {
    const f = inPhoto.files?.[0];
    if (f) {
      const url = URL.createObjectURL(f);
      photoPreview.src = url;
      photoPreviewWrap.classList.remove('hidden');
    } else {
      photoPreviewWrap.classList.add('hidden');
    }
  });

  // --- Session bootstrap ---
  supa.auth.onAuthStateChange(async (_event, session) => {
    if (session?.user) {
      await loadProfile();
      await refresh();
      authCard.classList.add('hidden');
      app.classList.remove('hidden');
    } else {
      authCard.classList.remove('hidden');
      app.classList.add('hidden');
    }
  });

  // If already signed in
  const { data: { session } } = await supa.auth.getSession();
  if (session?.user) {
    await loadProfile();
    await refresh();
    authCard.classList.add('hidden');
    app.classList.remove('hidden');
  }

  // --- Load profile / role ---
  async function loadProfile() {
    const { data: { user } } = await supa.auth.getUser();
    if (!user) return;
    const { data, error } = await supa
      .from('profiles')
      .select('id,email,role,org_id')
      .eq('id', user.id)
      .single();
    if (error) {
      console.warn('profile load error', error);
      return;
    }
    profile = data;
    isAdmin = profile.role === 'admin';
    currentOrg = profile.org_id;
    roleBadge.textContent = isAdmin ? 'Admin' : 'User';
    roleBadge.classList.remove('hidden');
    orgHint.textContent = `Org: ${currentOrg?.slice(0,8)}…`;
    // Admin UI bits
    chkAll.disabled = !isAdmin;
    btnExport.disabled = !isAdmin;
    lblImport.classList.toggle('hidden', !isAdmin);
  }

  // --- Photo uploader ---
  async function uploadPhoto(file, itemId) {
    if (!file) return null;
    const ext = file.name.split('.').pop() || 'jpg';
    const path = `${profile.id}/${itemId}_${Date.now()}.${ext}`;
    const { error } = await supa.storage.from('product_photos').upload(path, file, { upsert: false });
    if (error) { alert('Photo upload failed: ' + error.message); return null; }
    const { data } = supa.storage.from('product_photos').getPublicUrl(path);
    return data?.publicUrl || null;
  }

  // --- Add / Upsert item ---
  el('btnAdd').onclick = async () => {
    const barcode = inBarcode.value.trim();
    const name = inName.value.trim();
    const unit = inUnit.value.trim() || null;
    const pack = inPack.value.trim() || null;
    if (!barcode) return alert('Barcode is required');

    // Check if exists
    const { data: existing, error: exErr } = await supa
      .from('catalogue')
      .select('id,name')
      .eq('barcode', barcode)
      .limit(1)
      .maybeSingle();

    if (exErr) return alert(exErr.message);

    // Enforce name for NEW items
    if (!existing && !name) {
      return alert('Name is required for new items before adding to catalogue.');
    }

    let photo_url = null;
    // Create a temp id for path if inserting new
    const tempId = existing?.id || crypto.randomUUID();
    if (inPhoto.files?.[0]) {
      photo_url = await uploadPhoto(inPhoto.files[0], tempId);
    }

    const payload = {
      barcode,
      // Only send name if provided (so we don't overwrite accidentally on updates)
      ...(name ? { name } : {}),
      unit: unit,
      pack_size: pack,
      ...(photo_url ? { photo_url } : {})
    };

    // If exists, update; else insert
    let resp;
    if (existing) {
      resp = await supa.from('catalogue').update(payload).eq('id', existing.id).select().single();
    } else {
      // org_id and user_id set via trigger; WITH CHECK gate will enforce same-org
      resp = await supa.from('catalogue').insert(payload).select().single();
    }

    if (resp.error) return alert(resp.error.message);
    clearInputs();
    await refresh();
  };

  function clearInputs() {
    inBarcode.value = '';
    inName.value = '';
    inUnit.value = '';
    inPack.value = '';
    inPhoto.value = '';
    photoPreviewWrap.classList.add('hidden');
  }

  // --- Fetch catalogue (admin all vs org) ---
  async function fetchCatalogue() {
    const base = supa.from('v_catalogue_with_owner').select('*').order('updated_at', { ascending: false });
    if (isAdmin && viewAll) {
      return await base.limit(1000);
    } else {
      // RLS will already restrict to org; still call base
      return await base.limit(1000);
    }
  }

  async function refresh() {
    const { data, error } = await fetchCatalogue();
    if (error) { alert(error.message); return; }
    rows = data || [];
    render();
  }

  function render() {
    const q = inSearch.value.trim().toLowerCase();
    const filtered = !q ? rows : rows.filter(r =>
      (r.name||'').toLowerCase().includes(q) ||
      (r.barcode||'').toLowerCase().includes(q)
    );
    tblBody.innerHTML = '';
    for (const r of filtered) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.photo_url ? `<img src="${r.photo_url}" style="max-height:42px;border-radius:6px;border:1px solid rgba(255,255,255,.1)"/>` : ''}</td>
        <td class="mono">${r.barcode||''}</td>
        <td>${editable('name', r)}</td>
        <td>${editable('unit', r)}</td>
        <td>${editable('pack_size', r)}</td>
        <td class="owner">${r.owner_email ? r.owner_email : ''}</td>
        <td>
          <div class="flex">
            <label class="file" style="cursor:pointer">
              <input type="file" accept="image/*" class="hidden" data-photo="${r.id}"/>
              <span>Change photo</span>
            </label>
            ${isAdmin ? `<button class="btn danger" data-del="${r.id}">Delete</button>` : ''}
          </div>
        </td>
      `;
      tblBody.appendChild(tr);
    }
    // bind inline editors
    tblBody.querySelectorAll('input[data-edit]').forEach(inp => {
      inp.addEventListener('change', onInlineEdit);
      inp.addEventListener('blur', onInlineEdit);
      inp.addEventListener('keydown', (e)=>{ if(e.key==='Enter') onInlineEdit.call(inp,e); });
    });
    // bind photo changers
    tblBody.querySelectorAll('input[data-photo]').forEach(inp => {
      inp.addEventListener('change', onPhotoChange);
    });
    // bind deletes
    tblBody.querySelectorAll('button[data-del]').forEach(btn => {
      btn.addEventListener('click', async () => {
        if (!confirm('Delete this item?')) return;
        const id = btn.getAttribute('data-del');
        const { error } = await supa.from('catalogue').delete().eq('id', id);
        if (error) return alert(error.message);
        await refresh();
      });
    });
  }

  function editable(field, row) {
    const val = (row[field] ?? '');
    return `<input data-edit="${row.id}" data-field="${field}" value="${escapeHtml(val)}" />`;
  }

  function escapeHtml(s) {
    return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;');
  }

  async function onInlineEdit(e) {
    const input = e.currentTarget || this;
    const id = input.getAttribute('data-edit');
    const field = input.getAttribute('data-field');
    const value = input.value.trim() || null;
    // Prevent blanking the required name
    if (field === 'name' && (!value || value.length === 0)) {
      alert('Name is required.');
      return render();
    }
    const payload = {}; payload[field] = value;
    const { error } = await supa.from('catalogue').update(payload).eq('id', id);
    if (error) alert(error.message);
  }

  async function onPhotoChange(e) {
    const file = e.target.files?.[0];
    if (!file) return;
    const id = e.target.getAttribute('data-photo');
    const url = await uploadPhoto(file, id);
    if (!url) return;
    const { error } = await supa.from('catalogue').update({ photo_url: url }).eq('id', id);
    if (error) return alert(error.message);
    await refresh();
  }

  inSearch.addEventListener('input', render);
  el('btnRefresh').onclick = refresh;

  // Admin: view all toggle
  chkAll.addEventListener('change', async () => {
    if (!isAdmin) return;
    viewAll = chkAll.checked;
    await refresh();
  });

  // Export CSV (admin only)
  btnExport.addEventListener('click', () => {
    if (!isAdmin) return alert('Admins only');
    const csv = toCSV(rows, ['barcode','name','unit','pack_size','photo_url','owner_email','updated_at']);
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `catalogue_${new Date().toISOString().slice(0,10)}.csv`;
    a.click();
  });

  function toCSV(arr, cols) {
    const header = cols.join(',');
    const lines = arr.map(r => cols.map(c => csvCell(r[c])).join(','));
    return [header, ...lines].join('\n');
  }
  function csvCell(v) {
    if (v == null) return '';
    const s = String(v).replaceAll('"','""');
    if (/[",\n]/.test(s)) return `"${s}"`;
    return s;
  }

  // Import CSV (admin only): expects columns: barcode,name,unit,pack_size,photo_url
  inImport.addEventListener('change', async () => {
    if (!isAdmin) return alert('Admins only');
    const file = inImport.files?.[0];
    if (!file) return;
    const text = await file.text();
    const lines = text.split(/\r?\n/).filter(Boolean);
    const header = lines.shift().split(',');
    const idx = (k)=> header.findIndex(h => h.trim().toLowerCase()===k);
    const ib = idx('barcode'), iname = idx('name'), iunit = idx('unit'), ipack = idx('pack_size'), iphoto = idx('photo_url');
    if (ib<0 || iname<0) { alert('CSV needs at least barcode & name columns'); return; }
    const payloads = lines.map(line => {
      const cells = parseCSVLine(line, header.length);
      return {
        barcode: cells[ib]?.trim(),
        name: (cells[iname]||'').trim(),
        unit: (cells[iunit]||'').trim() || null,
        pack_size: (cells[ipack]||'').trim() || null,
        photo_url: (cells[iphoto]||'').trim() || null
      };
    }).filter(p => p.barcode && p.name);
    // Upsert by (org, barcode)
    for (const p of payloads) {
      const { error } = await supa.from('catalogue')
        .upsert(p, { onConflict: 'org_id,barcode' });
      if (error) { console.warn('import row error', error); }
    }
    alert('Import done');
    await refresh();
    inImport.value = '';
  });

  function parseCSVLine(line, ncols) {
    const out = []; let cur = ''; let inQ=false;
    for (let i=0;i<line.length;i++){
      const ch=line[i];
      if (inQ){
        if (ch === '"' && line[i+1] === '"'){cur+='"'; i++;}
        else if (ch === '"'){inQ=false;}
        else cur+=ch;
      } else {
        if (ch === ','){out.push(cur); cur='';}
        else if (ch === '"'){inQ=true;}
        else cur+=ch;
      }
    }
    out.push(cur);
    while(out.length<ncols) out.push('');
    return out;
  }

})();
</script>
</body>
</html>
