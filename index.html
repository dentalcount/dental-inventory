<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Dental Inventory</title>

<!-- Favicon (inline ðŸ¦·). To use your own file instead, replace this line with: <link rel="icon" href="favicon.ico"> -->
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3EðŸ¦·%3C/text%3E%3C/svg%3E">

<!-- Supabase SDK -->
<script src="https://unpkg.com/@supabase/supabase-js@2.44.4/dist/umd/supabase.js"></script>

<style>
  :root{--muted:#94a3b8;--text:#e5e7eb;--bg:#0b1220;--panel:#0c1426;--border:rgba(255,255,255,.10);--accent:#22d3ee}
  html,body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .wrap{max-width:1100px;margin:0 auto;padding:20px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px;margin:14px 0}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
  input,button,select{width:100%;padding:.7rem .8rem;border-radius:12px;border:1px solid var(--border);background:#0d1526;color:#e5e7eb;outline:none}
  input:focus,select:focus{border-color:var(--accent)}
  .btn{cursor:pointer;border:none}
  .btn.primary{background:linear-gradient(90deg,#00c2ff,#14f1d9);color:#022;font-weight:700}
  .btn.alt{background:#1f2937}
  .hidden{display:none!important}
  table{width:100%;border-collapse:separate;border-spacing:0 8px}
  th,td{padding:.6rem .55rem;text-align:left}
  thead th{font-size:.85rem;color:var(--muted)}
  tbody tr{background:#0d1629;border:1px solid rgba(255,255,255,.08)}
  tbody tr td:first-child{border-top-left-radius:10px;border-bottom-left-radius:10px}
  tbody tr td:last-child{border-top-right-radius:10px;border-bottom-right-radius:10px}
  .badge{padding:.2rem .5rem;border-radius:999px;border:1px solid var(--border);font-size:.75rem}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;}
  /* Debug dock */
  #debug{position:fixed;left:0;right:0;bottom:0;max-height:45vh;overflow:auto;background:#0a0f1d;border-top:1px solid var(--border);font-size:12px}
  #dbgHead{display:flex;gap:8px;align-items:center;padding:8px;border-bottom:1px solid var(--border)}
  #dbgBody{padding:8px}
  pre{white-space:pre-wrap;font-family:ui-monospace,Menlo,Consolas,monospace;margin:0}
  /* Scanner modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center}
  .sheet{background:#0b1220;border:1px solid var(--border);border-radius:16px;padding:16px;max-width:680px;width:92%}
  video{width:100%;max-height:300px;background:#000;border-radius:12px;border:1px solid var(--border)}
  canvas{display:none}
  .hint{color:var(--muted);font-size:.85rem}
  .file{display:inline-block;padding:.5rem .7rem;border:1px dashed var(--border);border-radius:8px;background:#101830;cursor:pointer}
  .file input{display:none}
</style>
</head>
<body>
<div class="wrap">
  <h1 style="display:flex;justify-content:space-between;align-items:center">
    <span>Dental Inventory <span id="roleBadge" class="badge hidden"></span></span>
    <span style="display:flex;gap:8px;align-items:center">
      <span id="userEmail" class="badge hidden"></span>
      <button id="btnShowDebug" class="btn alt">Show Debug</button>
      <button id="btnInAppReset" class="btn alt">Reset Session</button>
      <button id="btnSignOut" class="btn alt">Sign out</button>
    </span>
  </h1>

  <!-- Auth -->
  <div id="authCard" class="card">
    <div class="row">
      <div><input id="email" type="email" placeholder="you@clinic.com"/></div>
      <div style="align-self:end"><button id="btnMagic" class="btn primary">Send Magic Link</button></div>
    </div>
    <div class="row" style="margin-top:8px">
      <div><button id="btnGoogle" class="btn alt">Continue with Google</button></div>
      <div><button id="btnReset" class="btn alt">Reset Session</button></div>
    </div>
    <div class="hint" style="margin-top:8px">If Google shows the account chooser then returns here, thatâ€™s expectedâ€”PKCE finishes the sign-in on this page.</div>
  </div>

  <!-- App -->
  <div id="app" class="hidden">
    <!-- Add / Scan -->
    <div class="card">
      <div class="row3">
        <div>
          <div style="display:flex;gap:8px">
            <input id="inBarcode" class="mono" placeholder="Scan or type barcodeâ€¦"/>
            <button id="btnScan" class="btn alt" style="width:auto">ðŸ“· Scan</button>
          </div>
        </div>
        <div><input id="inName" placeholder="Item Name (required for new)"/></div>
        <div><input id="inUnit" placeholder="Unit (e.g., box / pack / ea)"/></div>
      </div>
      <div class="row3" style="margin-top:8px">
        <div><input id="inPack" placeholder="Pack size (e.g., x10 / 50pcs / 3g)"/></div>
        <div>
          <label class="file"><input id="inPhoto" type="file" accept="image/*" capture="environment"/>Upload Photo</label>
          <span id="photoName" class="hint" style="margin-left:8px"></span>
        </div>
        <div style="align-self:end"><button id="btnAdd" class="btn primary">Save / Upsert</button></div>
      </div>
    </div>

    <!-- Catalogue -->
    <div class="card">
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
        <input id="inSearch" placeholder="Search name or barcodeâ€¦" class="mono" style="flex:1 1 280px"/>
        <button id="btnRefresh" class="btn">Refresh</button>
        <button id="btnExport" class="btn">Export CSV</button>
        <label id="lblImport" class="file hidden"><input id="inImport" type="file" accept=".csv"/>Import CSV (admin)</label>
        <label class="hint" style="display:flex;gap:8px;align-items:center">
          <input id="chkAll" type="checkbox" disabled/> View all users
        </label>
        <span id="orgHint" class="badge"></span>
      </div>
      <div class="hint" style="margin-top:6px">Tip: click a field to edit inline. Press Enter to save.</div>
      <div style="overflow:auto;margin-top:8px">
        <table>
          <thead><tr><th>Photo</th><th>Barcode</th><th>Name</th><th>Unit</th><th>Pack</th><th>Owner</th><th>Actions</th></tr></thead>
          <tbody id="tblBody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Scanner Modal -->
<div id="scanModal" class="modal hidden">
  <div class="sheet">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <strong>Barcode Scanner</strong>
      <button id="btnScanClose" class="btn alt" style="width:auto">Close</button>
    </div>
    <video id="scanVideo" playsinline></video>
    <div class="hint" style="margin-top:6px">
      Position the barcode within the frame. If scanning doesnâ€™t start, your browser/device may not support the
      <code>BarcodeDetector</code> API; you can still type the barcode manually.
    </div>
  </div>
</div>

<!-- Debug Panel -->
<div id="debug" class="hidden">
  <div id="dbgHead">
    <button id="btnDbgRead" class="btn alt" style="width:auto">Perms: Read</button>
    <button id="btnDbgWrite" class="btn alt" style="width:auto">Perms: Write</button>
    <button id="btnDbgRaw" class="btn alt" style="width:auto">Raw REST</button>
    <span id="dbgStatus" style="margin-left:auto;color:#94a3b8"></span>
  </div>
  <div id="dbgBody">
    <div class="hint">URL: <span id="dbgUrl"></span></div>
    <pre id="log"></pre>
  </div>
</div>

<script>
(function(){
  /*** CONFIG ***/
  const REDIRECT_URL  = 'https://dentalcount.github.io/dental-inventory/';
  const SUPABASE_URL  = 'https://sgjoadsefpcixvmthtfy.supabase.co';
  const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNnam9hZHNlZnBjaXh2bXRodGZ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwMDIyMjYsImV4cCI6MjA3NDU3ODIyNn0.UcmAuHzEtKZIBs0pGkcLyRIYcLzCA4tNfuuDkUVLpU8';
  const STORAGE_BUCKET = 'product_photos';
  /***************/

  // Shorthands + Debug
  const $ = id => document.getElementById(id);
  const qs = new URLSearchParams(location.search);
  const DEBUG = qs.get('debug') === '1';
  const logEl = $('log'), dbgUrl = $('dbgUrl'), dbgStatus = $('dbgStatus');
  const dbg = (...a)=>{ console.log('[DBG]', ...a); if(DEBUG){ logEl.textContent += a.map(x=>typeof x==='string'?x:JSON.stringify(x)).join(' ') + '\n'; } };
  if (DEBUG) { $('debug').classList.remove('hidden'); dbgUrl.textContent = location.href; }
  $('btnShowDebug').onclick = ()=> $('debug').classList.remove('hidden');

  // Supabase client
  dbg('Creating clientâ€¦');
  const supa = window.supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON, {
    auth: { persistSession:true, detectSessionInUrl:true, flowType:'pkce' }
  });

  // DOM refs
  const authCard=$('authCard'), app=$('app'); const roleBadge=$('roleBadge'), userEmail=$('userEmail'), orgHint=$('orgHint');
  const inBarcode=$('inBarcode'), inName=$('inName'), inUnit=$('inUnit'), inPack=$('inPack'), inPhoto=$('inPhoto'), photoName=$('photoName');
  const tblBody=$('tblBody'); const chkAll=$('chkAll'); const btnExport=$('btnExport'); const lblImport=$('lblImport'); const inImport=$('inImport');

  let profile=null, isAdmin=false, rows=[];

  // Auth handlers
  async function boot() {
    const hasReturn = location.search.includes('?code=');
    dbg('Return handler start. hasReturn=', hasReturn, 'href=', location.href);
    const { data: { session } } = await supa.auth.getSession();
    if (session?.user) { await onSignedIn(session.user); if (hasReturn) history.replaceState({}, '', REDIRECT_URL); }
  }
  supa.auth.onAuthStateChange(async (event, session) => {
    dbg('onAuthStateChange', {event, hasSession: !!session});
    if (session?.user) await onSignedIn(session.user);
  });

  async function onSignedIn(user) {
    authCard.classList.add('hidden'); app.classList.remove('hidden');
    // Ensure profile exists; policies now allow self insert/select
    const pr = await supa.from('profiles').select('id,email,role,org_id').eq('id', user.id).maybeSingle();
    if (!pr.data) { await supa.from('profiles').upsert({ id:user.id, email:user.email }); }
    const p2 = pr.data || { id:user.id, email:user.email, role:'user', org_id:null };
    profile = p2; isAdmin = p2.role === 'admin';
    userEmail.textContent = p2.email || 'signed in'; userEmail.classList.remove('hidden');
    roleBadge.textContent = isAdmin ? 'Admin' : 'User'; roleBadge.classList.remove('hidden');
    orgHint.textContent = p2.org_id ? `Org: ${String(p2.org_id).slice(0,8)}â€¦` : 'Org: â€”';
    chkAll.disabled = !isAdmin; btnExport.disabled = false; lblImport.classList.toggle('hidden', !isAdmin);
    await refresh();
  }

  // Auth buttons
  $('btnMagic').onclick = async ()=>{
    const email = $('email').value.trim(); if(!email) return alert('Enter email');
    const { error } = await supa.auth.signInWithOtp({ email, options:{ emailRedirectTo: REDIRECT_URL } });
    if (error) return alert(error.message);
    alert('Check your email for the sign-in link.');
  };
  $('btnGoogle').onclick = async ()=>{
    const { error } = await supa.auth.signInWithOAuth({ provider:'google', options:{ redirectTo: REDIRECT_URL, queryParams:{ prompt:'select_account' } } });
    if (error) alert(error.message);
  };
  $('btnReset').onclick = async ()=>{ await supa.auth.signOut(); localStorage.clear(); sessionStorage.clear(); location.replace(REDIRECT_URL); };
  $('btnInAppReset').onclick = async ()=>{ await supa.auth.signOut(); localStorage.clear(); sessionStorage.clear(); location.replace(REDIRECT_URL); };
  $('btnSignOut').onclick = async ()=>{ await supa.auth.signOut(); localStorage.clear(); sessionStorage.clear(); location.replace(REDIRECT_URL); };

  // Scanner
  const scanModal = $('scanModal'); const scanVideo = $('scanVideo'); const btnScan = $('btnScan'); const btnScanClose=$('btnScanClose');
  let stream=null, detector=null, scanning=false, scanRAF=null;

  btnScan.onclick = async ()=>{
    scanModal.classList.remove('hidden');
    try {
      if ('BarcodeDetector' in window) {
        if (!detector) detector = new window.BarcodeDetector({ formats: ['ean_13','ean_8','code_128','upc_a','upc_e','code_39','itf'] });
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode:'environment' }, audio:false });
        scanVideo.srcObject = stream; await scanVideo.play();
        scanning = true; tickScan();
      } else {
        alert('BarcodeDetector is not supported on this browser/device. Please type the barcode manually.');
      }
    } catch (e) {
      alert('Camera access failed. Type the barcode manually.'); dbg('scan start err', e.message||e);
    }
  };
  btnScanClose.onclick = stopScan;
  function stopScan(){
    scanning=false; if (scanRAF) cancelAnimationFrame(scanRAF);
    if (scanVideo) { try{ scanVideo.pause(); }catch{} }
    if (stream) { stream.getTracks().forEach(t=>t.stop()); stream=null; }
    scanModal.classList.add('hidden');
  }
  async function tickScan(){
    if (!scanning) return;
    try{
      const codes = await detector.detect(scanVideo);
      if (codes && codes.length>0) {
        const code = codes[0].rawValue || codes[0].displayValue;
        if (code) { inBarcode.value = code; stopScan(); }
      }
    }catch(e){ /* ignore per-frame errors */ }
    scanRAF = requestAnimationFrame(tickScan);
  }

  // Photo input
  inPhoto.onchange = () => { photoName.textContent = inPhoto.files?.[0]?.name || ''; };

  async function uploadPhoto(file, itemId) {
    if (!file) return null;
    const ext = (file.name.split('.').pop() || 'jpg').toLowerCase();
    const path = `${profile?.id || 'anon'}/${itemId}_${Date.now()}.${ext}`;
    const up = await supa.storage.from(STORAGE_BUCKET).upload(path, file, { upsert:false });
    if (up.error) { alert('Photo upload failed: '+up.error.message); return null; }
    const pub = supa.storage.from(STORAGE_BUCKET).getPublicUrl(path);
    return pub?.data?.publicUrl || null;
  }

  // Save / Upsert (now returns rows)
  $('btnAdd').onclick = async ()=>{
    const barcode = inBarcode.value.trim();
    const name    = inName.value.trim();
    const unit    = inUnit.value.trim() || null;
    const pack    = inPack.value.trim() || null;
    if (!barcode) { alert('Barcode required'); return; }

    const cur = await supa.auth.getUser();
    const user = cur.data?.user; if (!user) return alert('Not signed in');

    const lookup = await supa.from('catalogue').select('id').eq('barcode', barcode).limit(1).maybeSingle();
    if (lookup.error) { return alert('Lookup failed: '+lookup.error.message); }

    const base = { barcode, unit, pack_size:pack, user_id:user.id };
    if (!lookup.data && !name) { return alert('Name required for new items'); }
    if (name) base.name = name;

    let photo_url = null;
    if (inPhoto.files?.[0]) {
      // if inserting, generate a temp id for filename, final row id comes after insert
      const tempId = lookup.data?.id || crypto.randomUUID();
      photo_url = await uploadPhoto(inPhoto.files[0], tempId);
      if (photo_url) base.photo_url = photo_url;
    }

    if (lookup.data) {
      const upd = await supa.from('catalogue').update(base).eq('id', lookup.data.id).select().single();
      if (upd.error) return alert('Update failed: '+upd.error.message);
      dbg('update -> OK', upd.data?.id);
    } else {
      const ins = await supa.from('catalogue').insert(base).select().single();
      if (ins.error) return alert('Insert failed: '+ins.error.message);
      dbg('insert -> OK', ins.data?.id);
    }

    // Clear form and refresh table
    inBarcode.value=''; inName.value=''; inUnit.value=''; inPack.value=''; inPhoto.value=''; photoName.textContent='';
    await refresh();
  };

  // Fetch and render
  async function refresh(){
    const q = await supa.from('v_catalogue_with_owner').select('*').order('updated_at',{ascending:false}).limit(1000);
    if (q.error) { if (DEBUG) dbg('view.select error', q.error.message||q.error); return; }
    rows = q.data || [];
    render();
  }

  function editable(field, row) {
    const val = row[field] ?? '';
    const esc = String(val).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;');
    return `<input data-edit="${row.id}" data-field="${field}" value="${esc}" />`;
  }

  function render(){
    const q = ($('inSearch').value||'').toLowerCase();
    const data = !q ? rows : rows.filter(r => (r.name||'').toLowerCase().includes(q) || (r.barcode||'').toLowerCase().includes(q));
    tblBody.innerHTML='';
    for (const r of data) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.photo_url ? `<img src="${r.photo_url}" style="max-height:42px;border-radius:6px;border:1px solid rgba(255,255,255,.1)"/>` : ''}</td>
        <td class="mono">${r.barcode||''}</td>
        <td>${editable('name', r)}</td>
        <td>${editable('unit', r)}</td>
        <td>${editable('pack_size', r)}</td>
        <td>${r.owner_email||''}</td>
        <td>
          <label class="file"><input type="file" accept="image/*" data-photo="${r.id}"/>Change photo</label>
        </td>`;
      tblBody.appendChild(tr);
    }
    // wire inline edits
    tblBody.querySelectorAll('input[data-edit]').forEach(inp=>{
      inp.addEventListener('keydown', e=>{ if(e.key==='Enter'){ onInlineEdit(e); }});
      inp.addEventListener('change', onInlineEdit);
    });
    // wire photo changes
    tblBody.querySelectorAll('input[data-photo]').forEach(inp=>{
      inp.addEventListener('change', onPhotoChange);
    });
  }

  async function onInlineEdit(e){
    const input = e.currentTarget;
    const id = input.getAttribute('data-edit');
    const field = input.getAttribute('data-field');
    const value = input.value.trim() || null;
    if (field === 'name' && (!value || value.length===0)) { alert('Name is required'); return render(); }
    const payload={}; payload[field]=value;
    const res = await supa.from('catalogue').update(payload).eq('id', id).select().single();
    if (res.error) alert(res.error.message);
    else dbg('inline edit OK', {id, field});
  }

  async function onPhotoChange(e){
    const file = e.target.files?.[0]; if(!file) return;
    const id = e.target.getAttribute('data-photo');
    const url = await uploadPhoto(file, id);
    if (!url) return;
    const res = await supa.from('catalogue').update({ photo_url:url }).eq('id', id).select().single();
    if (res.error) return alert(res.error.message);
    await refresh();
  }

  // CSV export/import
  $('btnExport').onclick = ()=>{
    const header = ['barcode','name','unit','pack_size','owner_email'];
    const lines = [header.join(',')];
    for (const r of rows) {
      const vals = [r.barcode||'', r.name||'', r.unit||'', r.pack_size||'', r.owner_email||'']
        .map(v => `"${String(v).replace(/"/g,'""')}"`);
      lines.push(vals.join(','));
    }
    const blob = new Blob([lines.join('\n')], {type:'text/csv'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'catalogue.csv'; a.click(); URL.revokeObjectURL(a.href);
  };

  inImport.onchange = async (e)=>{
    const file = e.target.files?.[0]; if(!file) return;
    if (!isAdmin) { alert('Only admin can import.'); return; }
    const txt = await file.text();
    const [headerLine, ...rowsTxt] = txt.split(/\r?\n/).filter(Boolean);
    const cols = headerLine.split(',').map(s=>s.replace(/^"|"$/g,''));
    const idx = { barcode: cols.indexOf('barcode'), name: cols.indexOf('name'), unit: cols.indexOf('unit'), pack_size: cols.indexOf('pack_size') };
    if (idx.barcode<0) return alert('CSV must include "barcode" column');
    const cur = await supa.auth.getUser(); const user = cur.data?.user;
    let ok=0, fail=0;
    for (const line of rowsTxt) {
      const parts = line.match(/("([^"]|"")*"|[^,]*)/g).filter((_,i)=>i%2===0)?.[0] ? line.split(',') : line.split(',');
      const get = i => { const raw = parts[i]||''; return raw.replace(/^"|"$/g,'').replace(/""/g,'"'); };
      const payload = { barcode: get(idx.barcode), user_id: user.id };
      if (idx.name>=0) payload.name = get(idx.name)||null;
      if (idx.unit>=0) payload.unit = get(idx.unit)||null;
      if (idx.pack_size>=0) payload.pack_size = get(idx.pack_size)||null;
      if (!payload.barcode) { fail++; continue; }
      const up = await supa.from('catalogue').upsert(payload, { onConflict:'barcode' });
      if (up.error) fail++; else ok++;
    }
    alert(`Import complete: ${ok} ok, ${fail} failed`);
    await refresh();
  };

  // Toolbar
  $('btnRefresh').onclick = refresh;
  $('inSearch').addEventListener('input', render);
  chkAll.addEventListener('change', ()=>{ /* Placeholder if you add org-sharing later */ refresh(); });

  // Debug toolbar actions
  $('btnDbgRead').onclick = async ()=>{
    dbg('READ viewâ€¦');
    const v = await supa.from('v_catalogue_with_owner').select('*').limit(1); dbg('view:', v.error?('ERR '+(v.error.message||v.error)):('OK count='+(v.data?.length||0)));
    const t = await supa.from('catalogue').select('*').limit(1); dbg('table:', t.error?('ERR '+(t.error.message||t.error)):('OK count='+(t.data?.length||0)));
  };
  $('btnDbgWrite').onclick = async ()=>{
    dbg('WRITE probeâ€¦');
    const u = await supa.auth.getUser(); if (!u.data?.user) return dbg('no user');
    const b = 'DEBUG-' + Math.random().toString(36).slice(2,6);
    const ins = await supa.from('catalogue').insert({ barcode:b, name:'probe', unit:'ea', pack_size:'1', user_id:u.data.user.id }).select().single();
    dbg(ins.error?('ERR '+(ins.error.message||ins.error)):`OK id=${ins.data?.id}`);
  };
  $('btnDbgRaw').onclick = async ()=>{
    dbg('RAW probeâ€¦');
    const s = await supa.auth.getSession(); const token = s.data?.session?.access_token;
    const url = `${SUPABASE_URL}/rest/v1/catalogue?select=id,barcode,name&limit=1`;
    try{
      const res = await fetch(url, { headers:{ apikey: SUPABASE_ANON, Authorization: token?`Bearer ${token}`:`Bearer ${SUPABASE_ANON}` } });
      const text = await res.text(); dbg('status', res.status, 'body', text);
    }catch(e){ dbg('fetch ERR', e.message||String(e)); }
  };

  // Start
  if (DEBUG) { dbg('Page load. hasReturn=', location.search.includes('?code='), 'href=', location.href); }
  boot();

})();
</script>
</body>
</html>
