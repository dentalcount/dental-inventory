<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Dental Inventory â€” Timeout Debug</title>
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3EðŸ¦·%3C/text%3E%3C/svg%3E">
<script src="https://unpkg.com/@supabase/supabase-js@2.44.4/dist/umd/supabase.js"></script>
<style>
  :root{--muted:#94a3b8;--text:#e5e7eb}
  html,body{margin:0;background:#0b1220;color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .wrap{max-width:1100px;margin:0 auto;padding:20px}
  .card{background:#0c1426;border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:16px;margin:14px 0}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
  input,button{width:100%;padding:.7rem .8rem;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#0d1526;color:#e5e7eb}
  .btn{cursor:pointer;border:none}
  .btn.primary{background:linear-gradient(90deg,#00c2ff,#14f1d9);color:#002b36;font-weight:700}
  .btn.alt{background:#1f2937}
  .hidden{display:none!important}
  #debugPanel{position:fixed;bottom:0;left:0;right:0;max-height:48vh;overflow:auto;background:#0a0f1d;border-top:1px solid rgba(255,255,255,.12);font-size:12px}
  #debugHead{display:flex;gap:8px;align-items:center;padding:8px;border-bottom:1px solid rgba(255,255,255,.08)}
  #debugBody{padding:8px}
  #log{white-space:pre-wrap;font-family:ui-monospace,Menlo,Consolas,monospace}
  .chip{border:1px solid rgba(255,255,255,.12);padding:.15rem .45rem;border-radius:999px;background:#101830}
  .badge{padding:.2rem .5rem;border-radius:999px;border:1px solid rgba(255,255,255,.08);font-size:.75rem}
</style>
</head>
<body>
<div class="wrap">
  <h1 class="flex" style="display:flex;justify-content:space-between;align-items:center">
    <span>Dental Inventory <span id="roleBadge" class="badge hidden"></span></span>
    <span style="display:flex;gap:8px;align-items:center">
      <span id="userEmail" class="badge hidden"></span>
      <button id="btnShowDebug" class="btn alt">Show Debug</button>
      <button id="btnInAppReset" class="btn alt">Reset Session</button>
      <button id="btnSignOut" class="btn alt">Sign out</button>
    </span>
  </h1>

  <!-- Auth -->
  <div id="authCard" class="card">
    <div class="row">
      <div><input id="email" type="email" placeholder="you@clinic.com"/></div>
      <div style="align-self:end"><button id="btnMagic" class="btn primary">Send Magic Link</button></div>
    </div>
    <div class="row" style="margin-top:8px">
      <div><button id="btnGoogle" class="btn alt">Continue with Google</button></div>
      <div><button id="btnReset" class="btn alt">Reset Session</button></div>
    </div>
  </div>

  <!-- App -->
  <div id="app" class="hidden">
    <div class="card">
      <div class="row3">
        <div><input id="inBarcode" placeholder="Barcode (required)"/></div>
        <div><input id="inName" placeholder="Item Name (required for new)"/></div>
        <div><input id="inUnit" placeholder="Unit"/></div>
      </div>
      <div class="row3" style="margin-top:8px">
        <div><input id="inPack" placeholder="Pack size"/></div>
        <div></div>
        <div style="align-self:end"><button id="btnAdd" class="btn primary">Save / Upsert</button></div>
      </div>
    </div>

    <div class="card">
      <div style="display:flex;gap:10px;align-items:center">
        <input id="inSearch" placeholder="Searchâ€¦"/>
        <button id="btnRefresh" class="btn">Refresh</button>
        <span id="orgHint" class="badge"></span>
      </div>
      <div style="overflow:auto;margin-top:8px">
        <table style="width:100%">
          <thead><tr><th>Barcode</th><th>Name</th><th>Unit</th><th>Pack</th><th>Owner</th></tr></thead>
          <tbody id="tblBody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Debug Panel -->
<div id="debugPanel" class="hidden">
  <div id="debugHead">
    <span class="chip">Auth/DB Debug</span>
    <button id="btnForceSession" class="btn alt" style="width:auto">Force Session</button>
    <button id="btnPermRead" class="btn alt" style="width:auto">Perms: Read</button>
    <button id="btnPermWrite" class="btn alt" style="width:auto">Perms: Write Probe</button>
    <button id="btnRawProbe" class="btn alt" style="width:auto">Raw REST Probe</button>
    <button id="btnDump" class="btn alt" style="width:auto">Dump State</button>
    <button id="btnNuke" class="btn alt" style="width:auto">Nuke Storage</button>
    <span id="dbgStatus" style="margin-left:auto;color:#94a3b8"></span>
  </div>
  <div id="debugBody">
    <div style="color:#94a3b8">URL: <span id="dbgUrl"></span></div>
    <div style="color:#94a3b8">localStorage OK? <span id="dbgLS"></span> â€¢ sessionStorage OK? <span id="dbgSS"></span></div>
    <pre id="log"></pre>
  </div>
</div>

<script>
(function boot(){
  if(!window.supabase){ return setTimeout(boot, 10); }

  /** CONFIG **/
  const REDIRECT_URL  = 'https://dentalcount.github.io/dental-inventory/';
  const SUPABASE_URL  = 'https://sgjoadsefpcixvmthtfy.supabase.co';
  const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNnam9hZHNlZnBjaXh2bXRodGZ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwMDIyMjYsImV4cCI6MjA3NDU3ODIyNn0.UcmAuHzEtKZIBs0pGkcLyRIYcLzCA4tNfuuDkUVLpU8';

  /* ===== Debug helpers ===== */
  const qs = new URLSearchParams(location.search);
  const DEBUG = qs.get('debug') === '1' || location.search.includes('?code=');
  const panel = document.getElementById('debugPanel');
  const logEl = document.getElementById('log');
  const dbgStatus = document.getElementById('dbgStatus');
  const dbgUrl = document.getElementById('dbgUrl');
  const dbgLS = document.getElementById('dbgLS');
  const dbgSS = document.getElementById('dbgSS');
  function showPanel(on){ panel.classList.toggle('hidden', !on); }
  const ts = ()=> new Date().toISOString().split('T')[1].replace('Z','');
  function dbg(...args){ console.log('[DBG]', ...args); if(DEBUG){ logEl.textContent += `[${ts()}] ${args.map(a=>typeof a==='string'?a:JSON.stringify(a)).join(' ')}\n`; } }
  function setStatus(s){ if(DEBUG){ dbgStatus.textContent = s; } }
  function storageOK(kind){ try{ const k='__t__'+Math.random(); (kind==='local'?localStorage:sessionStorage).setItem(k,'1'); (kind==='local'?localStorage:sessionStorage).removeItem(k); return true; }catch(e){ return false; } }

  if (DEBUG) { showPanel(true); dbgUrl.textContent = location.href; dbgLS.textContent = storageOK('local')?'yes':'no'; dbgSS.textContent = storageOK('session')?'yes':'no'; }

  window.addEventListener('error', e=>dbg('onerror', e.message));
  window.addEventListener('unhandledrejection', e=>dbg('unhandledrejection', e.reason?.message || String(e.reason)));

  /* === Promise.race timeout that RETURNS === */
  async function raceTimeout(label, promise, ms=5000) {
    let finished = false;
    const timed = new Promise(res=>setTimeout(()=>{ if(!finished){ dbg(`TIMEOUT(${label}): ${ms}ms`); res({ _timeout:true, label }); } }, ms));
    const result = await Promise.race([ promise.then(v=>({_ok:true, value:v})).catch(e=>({_err:true, error:e})), timed ]);
    finished = true;
    return result;
  }

  /* Create client */
  dbg('Creating clientâ€¦');
  const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON, {
    auth: { persistSession:true, detectSessionInUrl:true, flowType:'pkce' }
  });

  /* DOM refs */
  const $ = id=>document.getElementById(id);
  const authCard=$('authCard'), app=$('app'), roleBadge=$('roleBadge'), userEmail=$('userEmail'), orgHint=$('orgHint');
  const inBarcode=$('inBarcode'), inName=$('inName'), inUnit=$('inUnit'), inPack=$('inPack');
  const tblBody=$('tblBody');

  let profile=null, rows=[];

  $('btnShowDebug').onclick=()=>{ const now=panel.classList.contains('hidden'); showPanel(now); };

  /* Post-return poll */
  (async()=>{
    const cameBack = location.search.includes('?code=');
    dbg('Return handler start. hasReturn=', cameBack, 'href=', location.href);
    const pollEnd = Date.now()+8000;
    let sess = await supa.auth.getSession(); dbg('Initial getSession -> has user?', !!sess.data?.session?.user);
    while(!sess.data?.session?.user && Date.now()<pollEnd){
      setStatus('Waiting for sessionâ€¦'); await new Promise(r=>setTimeout(r,250));
      sess = await supa.auth.getSession();
    }
    if(sess.data?.session?.user){
      authCard.classList.add('hidden'); app.classList.remove('hidden');
      try{ await loadProfile(); }catch(e){ dbg('loadProfile ERR', e?.message||e); }
      try{ await refresh(); }catch(e){ dbg('refresh ERR', e?.message||e); }
      if (cameBack) history.replaceState({}, '', REDIRECT_URL);
    }
  })();

  /* Auth buttons */
  $('btnMagic').onclick = async ()=>{
    const email = $('email').value.trim(); if(!email) return alert('Enter email');
    const r = await raceTimeout('auth.signInWithOtp', supa.auth.signInWithOtp({ email, options:{ emailRedirectTo: REDIRECT_URL } }), 6000);
    dbg('signInWithOtp ->', r._timeout?'TIMEOUT': r._err?('ERR:'+ (r.error?.message||r.error)) : 'OK');
    if(r._err) alert(r.error?.message||String(r.error));
    if(!r._err && !r._timeout) alert('Check your email for the sign-in link.');
  };
  $('btnGoogle').onclick = async ()=>{
    const r = await raceTimeout('auth.signInWithOAuth', supa.auth.signInWithOAuth({ provider:'google', options:{ redirectTo: REDIRECT_URL, queryParams:{ prompt:'select_account' } } }), 6000);
    dbg('signInWithOAuth ->', r._timeout?'TIMEOUT': r._err?('ERR:'+ (r.error?.message||r.error)) : 'OK');
    if(r._err) alert(r.error?.message||String(r.error));
  };

  $('btnReset').onclick = async ()=>{
    dbg('pre-login reset');
    await raceTimeout('auth.signOut(pre)', supa.auth.signOut(), 3000);
    localStorage.clear(); sessionStorage.clear(); location.replace(REDIRECT_URL);
  };
  $('btnInAppReset').onclick = async ()=>{
    dbg('in-app reset clicked');
    await raceTimeout('auth.signOut(in-app)', supa.auth.signOut(), 3000);
    localStorage.clear(); sessionStorage.clear(); location.replace(REDIRECT_URL);
  };
  $('btnSignOut').onclick = async ()=>{
    dbg('signOut() clicked');
    await raceTimeout('auth.signOut(button)', supa.auth.signOut(), 3000);
    localStorage.clear(); sessionStorage.clear(); location.replace(REDIRECT_URL);
  };

  supa.auth.onAuthStateChange((event, session)=>{ dbg('onAuthStateChange', {event, hasSession:!!session}); });

  /* Debug toolbar actions */
  $('btnForceSession').onclick = async ()=>{
    const s = await raceTimeout('auth.getSession', supa.auth.getSession(), 4000);
    const u = await raceTimeout('auth.getUser', supa.auth.getUser(), 4000);
    dbg('getSession ->', s._timeout?'TIMEOUT': JSON.stringify(s.value));
    dbg('getUser ->', u._timeout?'TIMEOUT': JSON.stringify(u.value));
  };
  $('btnPermRead').onclick = async ()=>{
    dbg('Permissions READ testâ€¦');
    const v = await raceTimeout('read view', supa.from('v_catalogue_with_owner').select('*').limit(1), 6000);
    dbg('read view ->', v._timeout?'TIMEOUT': v._err?('ERR:'+ (v.error?.message||v.error)): ('OK count='+(v.value.data?.length||0)));
    const c = await raceTimeout('read table', supa.from('catalogue').select('*').limit(1), 6000);
    dbg('read table ->', c._timeout?'TIMEOUT': c._err?('ERR:'+ (c.error?.message||c.error)): ('OK count='+(c.value.data?.length||0)));
  };
  $('btnPermWrite').onclick = async ()=>{
    dbg('Permissions WRITE probeâ€¦');
    const barcode = 'DEBUG-' + Math.random().toString(36).slice(2,6);
    const ins = await raceTimeout('insert probe', supa.from('catalogue').insert({
      barcode, name:'probe', unit:'ea', pack_size:'1',
      ...(profile?.id?{user_id:profile.id}:{}) , ...(profile?.org_id?{org_id:profile.org_id}:{})
+   }), 6000);
    if(ins._timeout){ dbg('insert probe -> TIMEOUT'); }
    else if(ins._err){ dbg('insert probe -> ERR:', ins.error.message||String(ins.error)); }
    else if(ins.value?.data?.id){
      dbg('insert probe -> OK id=', ins.value.data.id);
      await raceTimeout('delete probe', supa.from('catalogue').delete().eq('id', ins.value.data.id), 4000);
    } else {
      dbg('insert probe -> OK but no readable row (RLS SELECT blocked)');
    }
  };
  $('btnRawProbe').onclick = async ()=>{
    dbg('Raw REST probeâ€¦');
    const s = await supa.auth.getSession(); const token = s.data?.session?.access_token;
    const url = `${SUPABASE_URL}/rest/v1/catalogue?select=id,barcode,name&limit=1`;
    try{
      const res = await fetch(url, { headers: { apikey: SUPABASE_ANON, Authorization: token?`Bearer ${token}`:`Bearer ${SUPABASE_ANON}`, 'X-Client-Info':'raw-probe' } });
      const text = await res.text();
      dbg('raw probe -> status', res.status, 'body:', text.slice(0,1000));
    }catch(e){ dbg('raw probe ERR', e.message||String(e)); }
  };
  $('btnDump').onclick = async ()=>{
    const s = await supa.auth.getSession(); const u = await supa.auth.getUser();
    dbg('dump session', s); dbg('dump user', u); dbg('localStorage keys', Object.keys(localStorage)); dbg('sessionStorage keys', Object.keys(sessionStorage));
  };
  $('btnNuke').onclick = async ()=>{
    await raceTimeout('auth.signOut(nuke)', supa.auth.signOut(), 3000);
    localStorage.clear(); sessionStorage.clear(); location.replace(REDIRECT_URL);
  };

  /* Profile / data */
  async function loadProfile(){
    const u = await raceTimeout('auth.getUser(profile)', supa.auth.getUser(), 4000);
    if(u._timeout || u._err || !u.value.data?.user){ dbg('getUser fail', u); return; }
    const user = u.value.data.user;
    const pr = await raceTimeout('profiles.select', supa.from('profiles').select('id,email,role,org_id').eq('id', user.id).maybeSingle(), 6000);
    if(pr._timeout){ dbg('profiles.select -> TIMEOUT'); return; }
    if(pr._err){ dbg('profiles.select -> ERR', pr.error.message||String(pr.error)); return; }
    profile = pr.value.data || { id: user.id, email: user.email, role: 'user', org_id: null };
    roleBadge.textContent = profile.role||'user'; roleBadge.classList.remove('hidden');
    userEmail.textContent = profile.email||''; userEmail.classList.remove('hidden');
    orgHint.textContent = profile.org_id ? `Org: ${String(profile.org_id).slice(0,8)}â€¦` : 'Org: â€”';
  }

  async function refresh(){
    const v = await raceTimeout('view.select', supa.from('v_catalogue_with_owner').select('*').order('updated_at', {ascending:false}).limit(500), 8000);
    if(v._timeout){ dbg('view.select -> TIMEOUT'); return; }
    if(v._err){ dbg('view.select -> ERR', v.error.message||String(v.error)); return; }
    rows = v.value.data||[];
    render();
  }

  function render(){
    const q = ($('inSearch').value||'').toLowerCase();
    const data = !q ? rows : rows.filter(r => (r.name||'').toLowerCase().includes(q) || (r.barcode||'').toLowerCase().includes(q));
    tblBody.innerHTML='';
    data.forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${r.barcode||''}</td><td>${r.name||''}</td><td>${r.unit||''}</td><td>${r.pack_size||''}</td><td>${r.owner_email||''}</td>`;
      tblBody.appendChild(tr);
    });
  }

  $('btnRefresh').onclick = refresh;
  $('inSearch').addEventListener('input', render);

  /* Save / Upsert with fallback REST call */
  $('btnAdd').onclick = async ()=>{
    const barcode = inBarcode.value.trim();
    const name = inName.value.trim();
    const unit = inUnit.value.trim()||null;
    const pack = inPack.value.trim()||null;
    dbg('btnAdd clicked', { barcode, name, unit, pack });
    if(!barcode){ alert('Barcode required'); return; }
    const lookup = await raceTimeout('lookup by barcode', supa.from('catalogue').select('id').eq('barcode', barcode).limit(1).maybeSingle(), 6000);
    if(lookup._timeout){ dbg('lookup -> TIMEOUT'); }
    if(lookup._err){ dbg('lookup -> ERR', lookup.error.message||String(lookup.error)); alert('Lookup failed'); return; }

    const payload = { barcode, ...(name?{name}:{}) , unit, pack_size:pack,
      ...(profile?.id?{user_id:profile.id}:{}) , ...(profile?.org_id?{org_id:profile.org_id}:{})
    };

    if (lookup.value?.data) {
      const upd = await raceTimeout('catalogue.update', supa.from('catalogue').update(payload).eq('id', lookup.value.data.id), 8000);
      if(upd._timeout){ dbg('update -> TIMEOUT (will try REST fallback)'); await restUpdate(lookup.value.data.id, payload); }
      else if(upd._err){ dbg('update -> ERR', upd.error.message||String(upd.error)); alert('Update failed: '+(upd.error.message||upd.error)); }
      else { dbg('update -> OK'); await refresh(); }
    } else {
      const ins = await raceTimeout('catalogue.insert', supa.from('catalogue').insert(payload), 8000);
      if(ins._timeout){ dbg('insert -> TIMEOUT (will try REST fallback)'); await restInsert(payload); }
      else if(ins._err){ dbg('insert -> ERR', ins.error.message||String(ins.error)); alert('Insert failed: '+(ins.error.message||ins.error)); }
      else { dbg('insert -> OK'); clearInputs(); await refresh(); }
    }
  };

  function clearInputs(){ inBarcode.value=''; inName.value=''; inUnit.value=''; inPack.value=''; }

  /* Direct REST fallbacks for clearer errors */
  async function restInsert(payload){
    const s = await supa.auth.getSession(); const token = s.data?.session?.access_token;
    const url = `${SUPABASE_URL}/rest/v1/catalogue`;
    try{
      const res = await fetch(url, { method:'POST', headers:{
        apikey: SUPABASE_ANON,
        Authorization: `Bearer ${token||SUPABASE_ANON}`,
        'Content-Type':'application/json',
        Prefer: 'return=representation'
      }, body: JSON.stringify(payload) });
      const text = await res.text();
      dbg('REST insert -> status', res.status, 'body', text.slice(0,1200));
      if(res.ok){ clearInputs(); await refresh(); } else { alert('REST insert error: '+text); }
    }catch(e){ dbg('REST insert fetch ERR', e.message||String(e)); }
  }
  async function restUpdate(id, payload){
    const s = await supa.auth.getSession(); const token = s.data?.session?.access_token;
    const url = `${SUPABASE_URL}/rest/v1/catalogue?id=eq.${encodeURIComponent(id)}`;
    try{
      const res = await fetch(url, { method:'PATCH', headers:{
        apikey: SUPABASE_ANON,
        Authorization: `Bearer ${token||SUPABASE_ANON}`,
        'Content-Type':'application/json',
        Prefer: 'return=representation'
      }, body: JSON.stringify(payload) });
      const text = await res.text();
      dbg('REST update -> status', res.status, 'body', text.slice(0,1200));
      if(res.ok){ await refresh(); } else { alert('REST update error: '+text); }
    }catch(e){ dbg('REST update fetch ERR', e.message||String(e)); }
  }

})();</script>
</body>
</html>

