-- Add minimum quantity to catalogue
alter table public.catalogue
  add column if not exists min_qty numeric(12,3) not null default 0;

-- Make sure views include min_qty
drop view if exists public.v_stock_per_item cascade;

create view public.v_stock_per_item as
select
  c.id as item_id,
  c.barcode,
  c.name,
  c.unit,
  c.pack_size,
  c.min_qty,
  c.photo_url,
  c.user_id,
  p.email as owner_email,
  coalesce(sum(v.qty_signed), 0) as stock_qty
from public.catalogue c
left join public.v_inv_transactions_signed v on v.item_id = c.id
left join public.profiles p on p.id = c.user_id
group by c.id, c.barcode, c.name, c.unit, c.pack_size, c.min_qty, c.photo_url, c.user_id, p.email;

grant select on public.v_stock_per_item to anon, authenticated;

-- Keep v_stock_per_lot as-is (no change needed)
