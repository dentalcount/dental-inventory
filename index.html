<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Dental Inventory â€” Debug</title>

  <link rel="icon"
        href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3EðŸ¦·%3C/text%3E%3C/svg%3E">

  <script src="https://unpkg.com/@supabase/supabase-js@2.44.4/dist/umd/supabase.js"></script>

  <style>
    :root{--bg:#0f172a;--card:#111827;--muted:#94a3b8;--text:#e5e7eb;--accent:#22d3ee}
    html,body{margin:0;height:100%;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#0b1220;color:var(--text)}
    .wrap{max-width:1100px;margin:0 auto;padding:20px}
    .card{background:linear-gradient(180deg,#0b1220,#0b1220) padding-box,linear-gradient(145deg,rgba(255,255,255,.12),rgba(255,255,255,0)) border-box;border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:16px;margin:14px 0}
    h1{font-weight:700;letter-spacing:.3px}
    label{display:block;margin:.5rem 0 .25rem;color:var(--muted);font-size:.9rem}
    input,button{width:100%;padding:.7rem .8rem;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#0d1526;color:#e5e7eb;outline:none}
    input:focus{border-color:var(--accent)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .btn{cursor:pointer;border:none}
    .btn.primary{background:linear-gradient(90deg,#00c2ff,#14f1d9);color:#002b36;font-weight:700}
    .btn.alt{background:#1f2937}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:.25rem .6rem;border-radius:999px;background:#102037;border:1px solid rgba(255,255,255,.08);color:#a5b4fc}
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    th,td{padding:.65rem .6rem;text-align:left}
    thead th{font-size:.85rem;color:var(--muted);font-weight:600}
    tbody tr{background:#0c1426;border:1px solid rgba(255,255,255,.06)}
    tbody tr td:first-child{border-top-left-radius:10px;border-bottom-left-radius:10px}
    tbody tr td:last-child{border-top-right-radius:10px;border-bottom-right-radius:10px}
    .flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .right{margin-left:auto}
    .hint{color:var(--muted);font-size:.85rem}
    .hidden{display:none !important}
    .badge{padding:.2rem .5rem;border-radius:999px;border:1px solid rgba(255,255,255,.08);font-size:.75rem}
    .owner{color:#93c5fd}
    .srch{display:flex;gap:10px;align-items:center}
    .file{padding:.5rem;background:#0d1628;border-radius:10px;border:1px dashed rgba(255,255,255,.12);cursor:pointer}
    .preview{max-height:64px;border-radius:8px;border:1px solid rgba(255,255,255,.1)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    #debugPanel{position:fixed;bottom:0;left:0;right:0;max-height:45vh;overflow:auto;background:#0a0f1d;border-top:1px solid rgba(255,255,255,.12);box-shadow:0 -4px 20px rgba(0,0,0,.35);font-size:12px}
    #debugHead{display:flex;gap:8px;align-items:center;padding:8px;border-bottom:1px solid rgba(255,255,255,.08)}
    #debugBody{padding:8px}
    #log{white-space:pre-wrap;font-family:ui-monospace,Menlo,Consolas,monospace}
    .chip{border:1px solid rgba(255,255,255,.12);padding:.15rem .45rem;border-radius:999px;background:#101830}
  </style>
</head>
<body>
<div class="wrap">
  <h1 class="flex" style="justify-content:space-between;align-items:center">
    <span>Dental Inventory <span id="roleBadge" class="pill hidden"></span></span>
    <span class="flex" style="gap:8px">
      <span id="userEmail" class="badge hidden"></span>
      <button id="btnShowDebug" class="btn alt">Show Debug</button>
      <button id="btnInAppReset" class="btn alt">Reset Session</button>
      <button id="btnSignOut" class="btn alt">Sign out</button>
    </span>
  </h1>

  <!-- Auth -->
  <div id="authCard" class="card">
    <div class="row">
      <div>
        <label>Email for magic link</label>
        <input id="email" type="email" placeholder="you@clinic.com"/>
      </div>
      <div style="align-self:end">
        <button id="btnMagic" class="btn primary">Send Sign-In Link</button>
      </div>
    </div>

    <div class="row" style="margin-top:8px">
      <div><button id="btnGoogle" class="btn alt">Continue with Google</button></div>
      <div><button id="btnReset" class="btn alt">Reset Session</button></div>
    </div>

    <div class="hint" style="margin-top:8px">
      Magic Link avoids OAuth domain quirks on GitHub Pages. Google works too once URL settings match exactly.
    </div>
  </div>

  <!-- App -->
  <div id="app" class="hidden">
    <div class="card">
      <div class="flex">
        <div class="pill">Add / Scan Item</div>
        <span class="right hint">New items require a <strong>Name</strong>.</span>
      </div>
      <div class="row3" style="margin-top:12px">
        <div><label>Barcode</label><input id="inBarcode" class="mono" placeholder="Scan or typeâ€¦"/></div>
        <div><label>Item Name</label><input id="inName" placeholder="e.g., GIC Fuji IX Capsule A2"/></div>
        <div><label>Unit</label><input id="inUnit" placeholder="box / pack / ea"/></div>
      </div>
      <div class="row3">
        <div><label>Pack Size</label><input id="inPack" placeholder="x10 / 50pcs / 3g"/></div>
        <div><label>Photo (optional)</label><input id="inPhoto" type="file" accept="image/*" capture="environment"/></div>
        <div style="align-self:end"><button id="btnAdd" class="btn primary">Save / Upsert</button></div>
      </div>
      <div id="photoPreviewWrap" class="flex hidden" style="margin-top:8px">
        <img id="photoPreview" class="preview" alt="preview"/><span class="hint">Photo will upload on save.</span>
      </div>
    </div>

    <div class="card">
      <div class="flex">
        <div class="pill">Catalogue</div>
        <div class="right" style="display:flex;gap:10px;align-items:center">
          <input id="inSearch" placeholder="Search name or barcodeâ€¦" class="mono"/>
          <button id="btnRefresh" class="btn">Refresh</button>
          <button id="btnExport" class="btn">Export CSV</button>
          <label class="file hidden" id="lblImport"><input id="inImport" type="file" accept=".csv" class="hidden"/><span>Import CSV (admin)</span></label>
        </div>
      </div>
      <div class="hint" style="margin:6px 0 10px">
        Admins can toggle <label style="display:inline;margin:0 6px"><input id="chkAll" type="checkbox"/> View all users</label>
        <span id="orgHint" class="badge"></span>
      </div>
      <div style="overflow:auto">
        <table>
          <thead><tr><th>Photo</th><th>Barcode</th><th>Name</th><th>Unit</th><th>Pack</th><th class="owner">Owner</th><th>Actions</th></tr></thead>
          <tbody id="tblBody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Debug Panel -->
<div id="debugPanel" class="hidden">
  <div id="debugHead">
    <span class="chip">Auth/DB Debug</span>
    <button id="btnForceSession" class="btn alt" style="width:auto">Force Session Check</button>
    <button id="btnPermRead" class="btn alt" style="width:auto">Permissions: Read</button>
    <button id="btnPermWrite" class="btn alt" style="width:auto">Permissions: Write Probe</button>
    <button id="btnDump" class="btn alt" style="width:auto">Dump State</button>
    <button id="btnNuke" class="btn alt" style="width:auto">Nuke Storage</button>
    <span id="dbgStatus" class="hint" style="margin-left:auto"></span>
  </div>
  <div id="debugBody">
    <div class="hint">URL: <span id="dbgUrl"></span></div>
    <div class="hint">localStorage OK? <span id="dbgLS"></span> â€¢ sessionStorage OK? <span id="dbgSS"></span></div>
    <pre id="log"></pre>
  </div>
</div>

<script>
(function boot() {
  if (!window.supabase) return setTimeout(boot, 10);

  /*** CONFIG ***/
  const REDIRECT_URL  = 'https://dentalcount.github.io/dental-inventory/';
  const SUPABASE_URL  = 'https://sgjoadsefpcixvmthtfy.supabase.co';
  const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNnam9hZHNlZnBjaXh2bXRodGZ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwMDIyMjYsImV4cCI6MjA3NDU3ODIyNn0.UcmAuHzEtKZIBs0pGkcLyRIYcLzCA4tNfuuDkUVLpU8';
  /**************/

  // ===== Debug helpers =====
  const qs = new URLSearchParams(location.search);
  const DEBUG = qs.get('debug') === '1' || localStorage.DEBUG_AUTH === '1' || location.search.includes('?code=');
  const panel = document.getElementById('debugPanel');
  const logEl = document.getElementById('log');
  const dbgStatus = document.getElementById('dbgStatus');
  const dbgUrl = document.getElementById('dbgUrl');
  const dbgLS = document.getElementById('dbgLS');
  const dbgSS = document.getElementById('dbgSS');
  const showPanel = (on)=> panel.classList.toggle('hidden', !on);
  const ts = () => new Date().toISOString().split('T')[1].replace('Z','');
  function dbg(...args){ console.log('[DBG]', ...args); if(DEBUG){ logEl.textContent += `[${ts()}] ${args.map(a => typeof a==='string'?a:JSON.stringify(a)).join(' ')}\n`; } }
  function setStatus(s){ if(DEBUG){ dbgStatus.textContent = s; } }
  function storageOK(kind){ try{ const k='__t__'+Math.random(); (kind==='local'?localStorage:sessionStorage).setItem(k,'1'); (kind==='local'?localStorage:sessionStorage).removeItem(k); return true; }catch(e){ return false; } }

  if (DEBUG) {
    showPanel(true);
    dbgUrl.textContent = location.href;
    dbgLS.textContent = storageOK('local') ? 'yes' : 'no';
    dbgSS.textContent = storageOK('session') ? 'yes' : 'no';
  }

  window.addEventListener('error', (e) => { dbg('window.onerror', {message:e.message, lineno:e.lineno, colno:e.colno}); });
  window.addEventListener('unhandledrejection', (e) => { dbg('unhandledrejection', {reason: (e.reason?.message || String(e.reason))}); });

  if (!/^https?:\/\/.+\.supabase\.co\/?$/i.test(SUPABASE_URL)) { alert('Config error: SUPABASE_URL invalid'); dbg('BAD SUPABASE_URL'); return; }
  if (!SUPABASE_ANON || SUPABASE_ANON.length < 50) { alert('Config error: anon key missing/too short'); dbg('BAD ANON KEY'); return; }

  dbg('Creating clientâ€¦');
  const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON, {
    auth: { persistSession: true, detectSessionInUrl: true, flowType: 'pkce' }
  });

  // ===== DOM =====
  const el = id => document.getElementById(id);
  const authCard = el('authCard');
  const app = el('app');
  const roleBadge = el('roleBadge');
  const orgHint = el('orgHint');
  const userEmailBadge = el('userEmail');
  const btnShowDebug = el('btnShowDebug');

  const inBarcode = el('inBarcode');
  const inName = el('inName');
  const inUnit = el('inUnit');
  const inPack = el('inPack');
  const inPhoto = el('inPhoto');
  const photoPreviewWrap = el('photoPreviewWrap');
  const photoPreview = el('photoPreview');
  const inSearch = el('inSearch');
  const tblBody = el('tblBody');
  const chkAll = el('chkAll');
  const btnExport = el('btnExport');
  const inImport = el('inImport');
  const lblImport = el('lblImport');

  let profile = null;
  let isAdmin = false;
  let rows = [];

  // Toggle debug
  btnShowDebug.onclick = () => {
    const now = panel.classList.contains('hidden');
    localStorage.DEBUG_AUTH = now ? '1' : '0';
    showPanel(now);
  };

  // Debug actions
  document.getElementById('btnForceSession').onclick = async () => {
    dbg('Force session checkâ€¦');
    const s = await supa.auth.getSession(); dbg('getSession()', s);
    const u = await supa.auth.getUser(); dbg('getUser()', u);
    setStatus('Forced session checked');
    if (s?.data?.session?.user) { authCard.classList.add('hidden'); app.classList.remove('hidden'); }
  };
  document.getElementById('btnPermRead').onclick = async () => {
    dbg('Permissions READ testâ€¦');
    const v = await supa.from('v_catalogue_with_owner').select('*').limit(1);
    dbg('v_catalogue_with_owner select', v);
    const c = await supa.from('catalogue').select('*').limit(1);
    dbg('catalogue select', c);
    setStatus('Read test done');
  };
  document.getElementById('btnPermWrite').onclick = async () => {
    dbg('Permissions WRITE probeâ€¦');
    const probeBarcode = 'DEBUG-PROBE-' + Math.random().toString(36).slice(2,8);
    const ins = await supa.from('catalogue').insert({
      barcode: probeBarcode, name: 'debug probe', unit: 'ea', pack_size: '1',
      owner_id: profile?.id || null, org_id: profile?.org_id || null
    }).select().single();
    dbg('insert probe', ins);
    if (!ins.error && ins.data?.id) {
      const del = await supa.from('catalogue').delete().eq('id', ins.data.id);
      dbg('delete probe', del);
    }
    setStatus('Write probe done');
  };
  document.getElementById('btnDump').onclick = async () => {
    dbg('Dumping stateâ€¦');
    dbg('location.href', location.href);
    dbg('localStorage keys', Object.keys(localStorage));
    dbg('sessionStorage keys', Object.keys(sessionStorage));
    const s = await supa.auth.getSession(); dbg('getSession()', s);
    const u = await supa.auth.getUser(); dbg('getUser()', u);
  };
  document.getElementById('btnNuke').onclick = async () => {
    dbg('Nuking storages & signOut');
    try { await supa.auth.signOut(); } catch (e){ dbg('signOut error', e.message||e); }
    localStorage.clear(); sessionStorage.clear();
    location.replace(REDIRECT_URL);
  };

  // Session arrival & initial render
  (async () => {
    const cameBackWithCode = location.search.includes('?code=');
    dbg('Return handler start. hasReturn=', cameBackWithCode, 'href=', location.href);
    const start = Date.now();
    const deadline = start + 8000;
    let tick = 0;

    let { data: { session } } = await supa.auth.getSession();
    dbg('Initial getSession -> has user?', !!session?.user);

    while (!session?.user && Date.now() < deadline) {
      tick++;
      setStatus(`Waiting for sessionâ€¦ (${tick})`);
      await new Promise(r => setTimeout(r, 250));
      ({ data: { session } } = await supa.auth.getSession());
      dbg(`Poll ${tick}: has user?`, !!session?.user);
    }

    if (session?.user) {
      dbg('Session available, rendering app.');
      authCard.classList.add('hidden');
      app.classList.remove('hidden');
      try { await loadProfile(); } catch(e){ dbg('loadProfile error', e); }
      try { await refresh(); } catch(e){ dbg('refresh error', e); }
      if (cameBackWithCode) history.replaceState({}, '', REDIRECT_URL);
      setStatus('Rendered with active session.');
    } else {
      dbg('No session after polling. Staying on login.');
      setStatus('No session found after polling.');
    }
  })();

  // AUTH UI
  el('btnMagic').onclick = async () => {
    const email = el('email').value.trim();
    if (!email) return alert('Enter your email');
    dbg('signInWithOtp ->', email);
    const { data, error } = await supa.auth.signInWithOtp({
      email,
      options: { emailRedirectTo: REDIRECT_URL }
    });
    dbg('signInWithOtp result', { ok: !error, error: error?.message });
    if (error) return alert(error.message);
    alert('Check your email for the sign-in link.');
  };

  el('btnGoogle').onclick = async () => {
    dbg('signInWithOAuth -> google');
    const { data, error } = await supa.auth.signInWithOAuth({
      provider: 'google',
      options: { redirectTo: REDIRECT_URL, queryParams: { prompt: 'select_account' } }
    });
    dbg('signInWithOAuth result', { ok: !error, error: error?.message });
    if (error) alert(error.message);
  };

  // Pre-login reset
  el('btnReset').onclick = async () => {
    dbg('pre-login reset: signOut + storage clear');
    try { await supa.auth.signOut(); } catch (e){ dbg('signOut error', e.message||e); }
    localStorage.clear(); sessionStorage.clear();
    location.replace(REDIRECT_URL);
  };

  // In-app reset + sign-out (hard reloads)
  el('btnInAppReset').onclick = async () => {
    dbg('in-app reset clicked');
    try { await supa.auth.signOut(); } catch (e){ dbg('signOut error', e.message||e); }
    authCard.classList.remove('hidden'); app.classList.add('hidden');
    localStorage.clear(); sessionStorage.clear();
    location.replace(REDIRECT_URL);
  };
  el('btnSignOut').onclick = async () => {
    dbg('signOut() clicked â€” before getSession');
    const before = await supa.auth.getSession(); dbg('session before signOut', before);
    const res = await supa.auth.signOut(); dbg('signOut() result', res);
    const after = await supa.auth.getSession(); dbg('session after signOut', after);
    authCard.classList.remove('hidden'); app.classList.add('hidden');
    // Hard reload to fully clear UI state
    location.replace(REDIRECT_URL);
  };

  // Auth listener
  supa.auth.onAuthStateChange(async (event, session) => {
    dbg('onAuthStateChange', { event, hasSession: !!session });
    if (session?.user) {
      authCard.classList.add('hidden');
      app.classList.remove('hidden');
      try { await loadProfile(); } catch(e){ dbg('loadProfile error (listener)', e); }
      try { await refresh(); } catch(e){ dbg('refresh error (listener)', e); }
      setStatus(`Auth event: ${event}`);
    }
  });

  // Helpers
  async function ensureProfileRow(user) {
    try {
      const { data, error } = await supa.from('profiles').select('id,org_id').eq('id', user.id).maybeSingle();
      if (error && error.code !== 'PGRST116') throw error;
      if (!data) {
        dbg('ensureProfileRow: inserting minimal row');
        await supa.from('profiles').upsert({ id: user.id, email: user.email }, { onConflict: 'id' });
      }
    } catch (e) { dbg('ensureProfileRow skipped', e?.message||e); }
  }

  async function loadProfile() {
    const u = await supa.auth.getUser();
    dbg('getUser()', u);
    const user = u?.data?.user;
    if (!user) return;
    await ensureProfileRow(user);

    const { data, error } = await supa
      .from('profiles')
      .select('id,email,role,org_id')
      .eq('id', user.id)
      .single();
    dbg('profiles fetch', { ok: !error, error: error?.message, data });
    if (error) return;

    profile = data;
    isAdmin = profile.role === 'admin';
    roleBadge.textContent = isAdmin ? 'Admin' : 'User';
    roleBadge.classList.remove('hidden');
    userEmailBadge.textContent = profile.email || 'Signed in';
    userEmailBadge.classList.remove('hidden');
    orgHint.textContent = `Org: ${String(profile.org_id||'').slice(0,8)}â€¦`;

    el('chkAll').disabled = !isAdmin;
    btnExport.disabled = !isAdmin;
    lblImport.classList.toggle('hidden', !isAdmin);
  }

  // Inventory
  inPhoto.addEventListener('change', () => {
    const f = inPhoto.files?.[0];
    if (f) { photoPreview.src = URL.createObjectURL(f); photoPreviewWrap.classList.remove('hidden'); }
    else { photoPreviewWrap.classList.add('hidden'); }
  });

  async function uploadPhoto(file, itemId) {
    if (!file) return null;
    const ext = (file.name.split('.').pop() || 'jpg').toLowerCase();
    const path = `${profile?.id || 'anon'}/${itemId}_${Date.now()}.${ext}`;
    const { data, error } = await supa.storage.from('product_photos').upload(path, file, { upsert: false });
    dbg('uploadPhoto', { path, ok: !error, error: error?.message });
    if (error) { alert('Photo upload failed: ' + error.message); return null; }
    const pub = supa.storage.from('product_photos').getPublicUrl(path);
    dbg('getPublicUrl', pub);
    return pub?.data?.publicUrl || null;
  }

  el('btnAdd').onclick = async () => {
    const barcode = inBarcode.value.trim();
    const name = inName.value.trim();
    const unit = inUnit.value.trim() || null;
    const pack = inPack.value.trim() || null;
    dbg('btnAdd clicked', { barcode, name, unit, pack });

    if (!barcode) { alert('Barcode is required'); return; }

    // Lookup existing
    const existing = await supa
      .from('catalogue')
      .select('id,name')
      .eq('barcode', barcode)
      .limit(1)
      .maybeSingle();
    dbg('lookup existing', existing);
    if (existing.error) { alert('Lookup failed: ' + existing.error.message); return; }

    if (!existing.data && !name) { alert('Name is required for new items.'); return; }

    const tmpId = existing.data?.id || crypto.randomUUID();
    let photo_url = null;
    if (inPhoto.files?.[0]) { photo_url = await uploadPhoto(inPhoto.files[0], tmpId); }

    // Include owner_id & org_id to satisfy typical RLS
    const payload = {
      barcode,
      ...(name ? { name } : {}),
      unit,
      pack_size: pack,
      ...(photo_url ? { photo_url } : {}),
      ...(profile?.id ? { owner_id: profile.id } : {}),
      ...(profile?.org_id ? { org_id: profile.org_id } : {})
    };
    dbg('upsert payload', payload);

    let resp;
    if (existing.data) {
      resp = await supa.from('catalogue').update(payload).eq('id', existing.data.id).select().single();
    } else {
      resp = await supa.from('catalogue').insert(payload).select().single();
    }
    dbg('upsert result', resp);

    if (resp.error) { alert('Save failed: ' + resp.error.message); return; }
    clearInputs();
    await refresh();
  };

  function clearInputs() {
    inBarcode.value = ''; inName.value = ''; inUnit.value = ''; inPack.value = '';
    inPhoto.value = ''; photoPreviewWrap.classList.add('hidden');
  }

  async function fetchCatalogue() {
    const v = await supa.from('v_catalogue_with_owner')
      .select('*')
      .order('updated_at', { ascending: false })
      .limit(1000);
    dbg('fetchCatalogue view', { count: v.data?.length || 0, error: v.error?.message });
    return v;
  }

  async function refresh() {
    const { data, error } = await fetchCatalogue();
    if (error) { alert('Fetch failed: ' + error.message); return; }
    rows = data || [];
    render();
  }

  function render() {
    const q = inSearch.value.trim().toLowerCase();
    const filtered = !q ? rows : rows.filter(r =>
      (r.name||'').toLowerCase().includes(q) || (r.barcode||'').toLowerCase().includes(q)
    );
    const tbody = document.getElementById('tblBody');
    tbody.innerHTML = '';
    for (const r of filtered) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.photo_url ? `<img src="${r.photo_url}" style="max-height:42px;border-radius:6px;border:1px solid rgba(255,255,255,.1)"/>` : ''}</td>
        <td class="mono">${r.barcode||''}</td>
        <td>${editable('name', r)}</td>
        <td>${editable('unit', r)}</td>
        <td>${editable('pack_size', r)}</td>
        <td class="owner">${r.owner_email ? r.owner_email : ''}</td>
        <td>
          <div class="flex">
            <label class="file">
              <input type="file" accept="image/*" class="hidden" data-photo="${r.id}"/><span>Change photo</span>
            </label>
          </div>
        </td>`;
      tbody.appendChild(tr);
    }
    tbody.querySelectorAll('input[data-edit]').forEach(inp => {
      inp.addEventListener('change', onInlineEdit);
      inp.addEventListener('keydown', e => { if (e.key==='Enter') onInlineEdit.call(inp,e); });
    });
    tbody.querySelectorAll('input[data-photo]').forEach(inp => {
      inp.addEventListener('change', onPhotoChange);
    });
  }

  function editable(field, row) {
    const val = (row[field] ?? '');
    return `<input data-edit="${row.id}" data-field="${field}" value="${String(val).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;')}" />`;
  }

  async function onInlineEdit(e) {
    const input = e.currentTarget || this;
    const id = input.getAttribute('data-edit');
    const field = input.getAttribute('data-field');
    const value = input.value.trim() || null;
    dbg('inline edit', { id, field, value });
    if (field === 'name' && (!value || value.length === 0)) { alert('Name is required.'); return render(); }
    const payload = {}; payload[field] = value;
    // Include owner/org on updates too, if RLS needs them
    if (profile?.id) payload.owner_id = profile.id;
    if (profile?.org_id) payload.org_id = profile.org_id;
    const res = await supa.from('catalogue').update(payload).eq('id', id);
    dbg('inline edit result', res);
    if (res.error) alert(res.error.message);
  }

  async function onPhotoChange(e) {
    const file = e.target.files?.[0]; if (!file) return;
    const id = e.target.getAttribute('data-photo');
    const url = await uploadPhoto(file, id);
    dbg('photo change -> uploaded url', url);
    if (!url) return;
    const payload = { photo_url: url };
    if (profile?.id) payload.owner_id = profile.id;
    if (profile?.org_id) payload.org_id = profile.org_id;
    const res = await supa.from('catalogue').update(payload).eq('id', id);
    dbg('photo update result', res);
    if (res.error) return alert(res.error.message);
    await refresh();
  }

  // Misc UI
  el('btnRefresh').onclick = () => { dbg('refresh clicked'); refresh(); };
  el('chkAll').addEventListener('change', () => { dbg('chkAll change', el('chkAll').checked); refresh(); });
  el('inSearch').addEventListener('input', () => { dbg('search input', el('inSearch').value); render(); });

})(); // boot
</script>
</body>
</html>
